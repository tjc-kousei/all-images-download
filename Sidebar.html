<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2487.4">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #6d6d6d; -webkit-text-stroke: #6d6d6d}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #1443ae; -webkit-text-stroke: #1443ae}
    p.p3 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #12737e; -webkit-text-stroke: #12737e}
    p.p4 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #2e3133; -webkit-text-stroke: #2e3133}
    p.p5 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #156227; -webkit-text-stroke: #156227}
    p.p6 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #a20010; -webkit-text-stroke: #a20010}
    p.p7 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #2e3133; -webkit-text-stroke: #2e3133; min-height: 15.0px}
    p.p8 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #4d5055; -webkit-text-stroke: #4d5055}
    p.p9 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #6103ad; -webkit-text-stroke: #6103ad}
    p.p10 {margin: 0.0px 0.0px 0.0px 0.0px; font: 13.0px Menlo; color: #18191b; -webkit-text-stroke: #18191b}
    span.s1 {font-kerning: none; background-color: #f6f7f9}
    span.s2 {font-kerning: none; color: #fb0007; background-color: #f6f7f9; -webkit-text-stroke: 0px #fb0007}
    span.s3 {font-kerning: none; color: #2a2a2a; background-color: #f6f7f9; -webkit-text-stroke: 0px #2a2a2a}
    span.s4 {font-kerning: none; color: #2e3133; background-color: #f6f7f9; -webkit-text-stroke: 0px #2e3133}
    span.s5 {font-kerning: none; color: #1443ae; background-color: #f6f7f9; -webkit-text-stroke: 0px #1443ae}
    span.s6 {font-kerning: none; color: #a20010; background-color: #f6f7f9; -webkit-text-stroke: 0px #a20010}
    span.s7 {font-kerning: none; color: #12737e; background-color: #f6f7f9; -webkit-text-stroke: 0px #12737e}
    span.s8 {font-kerning: none; color: #6103ad; background-color: #f6f7f9; -webkit-text-stroke: 0px #6103ad}
    span.s9 {font-kerning: none; color: #137646; background-color: #f6f7f9; -webkit-text-stroke: 0px #137646}
    span.s10 {font-kerning: none; color: #093c94; background-color: #f6f7f9; -webkit-text-stroke: 0px #093c94}
    span.s11 {font-kerning: none}
    span.s12 {font-kerning: none; color: #ba0673; background-color: #f6f7f9; -webkit-text-stroke: 0px #ba0673}
    span.s13 {font-kerning: none; color: #18191b; background-color: #f6f7f9; -webkit-text-stroke: 0px #18191b}
    span.s14 {font-kerning: none; color: #2316b2; background-color: #f6f7f9; -webkit-text-stroke: 0px #2316b2}
  </style>
</head>
<body>
<p class="p1"><span class="s1">&lt;!DOCTYPE</span><span class="s2"> html</span><span class="s1">&gt;</span></p>
<p class="p2"><span class="s3">&lt;</span><span class="s1">html</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;</span><span class="s1">head</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s3">&lt;</span><span class="s5">meta</span><span class="s4"> </span><span class="s1">charset</span><span class="s3">=</span><span class="s6">"UTF-8"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s3">&lt;</span><span class="s5">title</span><span class="s3">&gt;</span><span class="s1">画像一括ダウンロードツール</span><span class="s3">&lt;/</span><span class="s5">title</span><span class="s3">&gt;</span></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">&lt;!-- JSZip（CDN） --&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s3">&lt;</span><span class="s5">script</span><span class="s4"> </span><span class="s7">src</span><span class="s3">=</span><span class="s1">"https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"</span><span class="s3">&gt;&lt;/</span><span class="s5">script</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s3">&lt;</span><span class="s1">style</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">*</span><span class="s4">{</span><span class="s1">box-sizing:</span><span class="s6">border-box</span><span class="s4">}</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">body</span><span class="s4">{</span><span class="s7">font:</span><span class="s9">13px</span><span class="s4">/</span><span class="s9">1.6</span><span class="s4"> </span><span class="s1">system-ui</span><span class="s4">,</span><span class="s1">-apple-system</span><span class="s4">,</span><span class="s1">Segoe</span><span class="s4"> </span><span class="s1">UI</span><span class="s4">,</span><span class="s1">Roboto</span><span class="s4">,</span><span class="s1">sans-serif</span><span class="s4">;</span><span class="s7">margin:</span><span class="s9">0</span><span class="s4">;</span><span class="s7">padding:</span><span class="s9">12px</span><span class="s4">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s8">h3</span><span class="s1">{</span><span class="s7">margin:</span><span class="s9">0</span><span class="s1"> </span><span class="s9">0</span><span class="s1"> </span><span class="s9">8px</span><span class="s1">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">label</span><span class="s4">{</span><span class="s1">display:</span><span class="s6">block</span><span class="s4">;</span><span class="s1">margin:</span><span class="s9">8px</span><span class="s4"> </span><span class="s9">0</span><span class="s4"> </span><span class="s9">4px</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">input</span><span class="s4">[</span><span class="s6">type</span><span class="s4">=</span><span class="s6">text</span><span class="s4">],</span><span class="s8">input</span><span class="s4">[</span><span class="s6">type</span><span class="s4">=</span><span class="s6">number</span><span class="s4">],</span><span class="s8">select</span><span class="s4">{</span><span class="s1">width:</span><span class="s9">100%</span><span class="s4">;</span><span class="s1">padding:</span><span class="s9">8px</span><span class="s4">;</span><span class="s1">min-width:</span><span class="s9">0</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">button</span><span class="s4">{</span><span class="s1">padding:</span><span class="s9">10px</span><span class="s4"> </span><span class="s9">12px</span><span class="s4">;</span><span class="s1">width:</span><span class="s9">100%</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.muted</span><span class="s4">{</span><span class="s1">color:</span><span class="s10">#666</span><span class="s4">;</span><span class="s1">font-size:</span><span class="s9">12px</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.ok</span><span class="s4">{</span><span class="s1">color:</span><span class="s10">#0a8</span><span class="s4">;</span><span class="s1">margin-top:</span><span class="s9">8px</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.err</span><span class="s4">{</span><span class="s1">color:</span><span class="s10">#d33</span><span class="s4">;</span><span class="s1">margin-top:</span><span class="s9">8px</span><span class="s4">;</span><span class="s1">white-space:</span><span class="s6">pre-line</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">progress</span><span class="s4">{</span><span class="s1">width:</span><span class="s9">100%</span><span class="s4">;</span><span class="s1">height:</span><span class="s9">16px</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.small</span><span class="s4">{</span><span class="s1">font-size:</span><span class="s9">12px</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.section</span><span class="s4">{</span><span class="s1">margin-top:</span><span class="s9">12px</span><span class="s4">}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s1">/* レスポンシブ配置 */</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.grid-2</span><span class="s4">{</span><span class="s1">display:</span><span class="s6">grid</span><span class="s4">;</span><span class="s1">grid-template-columns:</span><span class="s9">1fr</span><span class="s4">;</span><span class="s1">gap:</span><span class="s9">8px</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.grid-3</span><span class="s4">{</span><span class="s1">display:</span><span class="s6">grid</span><span class="s4">;</span><span class="s1">grid-template-columns:</span><span class="s9">1fr</span><span class="s4">;</span><span class="s1">gap:</span><span class="s9">8px</span><span class="s4">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>@</span><span class="s8">media</span><span class="s1">(</span><span class="s8">min-width:</span><span class="s1">520</span><span class="s8">px</span><span class="s1">){.grid-2{</span><span class="s7">grid-template-columns:</span><span class="s9">1fr</span><span class="s1"> </span><span class="s9">1fr</span><span class="s1">}}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>@</span><span class="s8">media</span><span class="s1">(</span><span class="s8">min-width:</span><span class="s1">680</span><span class="s8">px</span><span class="s1">){.grid-3{</span><span class="s7">grid-template-columns:</span><span class="s9">1fr</span><span class="s1"> </span><span class="s9">1fr</span><span class="s1"> </span><span class="s9">1fr</span><span class="s1">}}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s1">/* プレビュー */</span></p>
<p class="p9"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s1">.previewWrap</span><span class="s4">{</span><span class="s7">margin-top:</span><span class="s9">12px</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.previewHead</span><span class="s4">{</span><span class="s1">display:</span><span class="s6">flex</span><span class="s4">;</span><span class="s1">gap:</span><span class="s9">8px</span><span class="s4">;</span><span class="s1">align-items:</span><span class="s6">center</span><span class="s4">;</span><span class="s1">flex-wrap:</span><span class="s6">wrap</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.badge</span><span class="s4">{</span><span class="s1">display:</span><span class="s6">inline-block</span><span class="s4">;</span><span class="s1">padding:</span><span class="s9">2px</span><span class="s4"> </span><span class="s9">6px</span><span class="s4">;</span><span class="s1">font-size:</span><span class="s9">11px</span><span class="s4">;</span><span class="s1">background:</span><span class="s10">#eee</span><span class="s4">;</span><span class="s1">border-radius:</span><span class="s9">4px</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.pvControls</span><span class="s4">{</span><span class="s1">display:</span><span class="s6">grid</span><span class="s4">;</span><span class="s1">grid-template-columns:</span><span class="s9">1fr</span><span class="s4"> </span><span class="s9">120px</span><span class="s4">;</span><span class="s1">gap:</span><span class="s9">8px</span><span class="s4">;</span><span class="s1">align-items:</span><span class="s6">center</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.pvMode</span><span class="s4">{</span><span class="s1">display:</span><span class="s6">flex</span><span class="s4">;</span><span class="s1">gap:</span><span class="s9">6px</span><span class="s4">;</span><span class="s1">flex-wrap:</span><span class="s6">wrap</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.pvBox</span><span class="s4">{</span><span class="s1">border:</span><span class="s9">1px</span><span class="s4"> </span><span class="s6">solid</span><span class="s4"> </span><span class="s10">#ddd</span><span class="s4">;</span><span class="s1">background:</span><span class="s10">#fff</span><span class="s4">;</span><span class="s1">padding:</span><span class="s9">4px</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.pvSideBySide</span><span class="s4">{</span><span class="s1">display:</span><span class="s6">grid</span><span class="s4">;</span><span class="s1">grid-template-columns:</span><span class="s9">1fr</span><span class="s4">;</span><span class="s1">gap:</span><span class="s9">8px</span><span class="s4">}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>@</span><span class="s8">media</span><span class="s1">(</span><span class="s8">min-width:</span><span class="s1">480</span><span class="s8">px</span><span class="s1">){.pvSideBySide{</span><span class="s7">grid-template-columns:</span><span class="s9">1fr</span><span class="s1"> </span><span class="s9">1fr</span><span class="s1">}}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">canvas</span><span class="s4">{</span><span class="s1">max-width:</span><span class="s9">100%</span><span class="s4">;</span><span class="s1">height:</span><span class="s6">auto</span><span class="s4">;</span><span class="s1">display:</span><span class="s6">block</span><span class="s4">}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s1">/* 比較スライダー */</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.cmpWrap</span><span class="s4">{</span><span class="s1">position:</span><span class="s6">relative</span><span class="s4">;</span><span class="s1">width:</span><span class="s9">100%</span><span class="s4">;</span><span class="s1">background:</span><span class="s10">#fff</span><span class="s4">;</span><span class="s1">border:</span><span class="s9">1px</span><span class="s4"> </span><span class="s6">solid</span><span class="s4"> </span><span class="s10">#ddd</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.cmpBase</span><span class="s4">{</span><span class="s1">display:</span><span class="s6">block</span><span class="s4">;</span><span class="s1">width:</span><span class="s9">100%</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.cmpMask</span><span class="s4">{</span><span class="s1">position:</span><span class="s6">absolute</span><span class="s4">;</span><span class="s1">left:</span><span class="s9">0</span><span class="s4">;</span><span class="s1">top:</span><span class="s9">0</span><span class="s4">;</span><span class="s1">bottom:</span><span class="s9">0</span><span class="s4">;</span><span class="s1">overflow:</span><span class="s6">hidden</span><span class="s4">;</span><span class="s1">border-right:</span><span class="s9">2px</span><span class="s4"> </span><span class="s6">solid</span><span class="s4"> </span><span class="s10">#fff</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.cmpTop</span><span class="s4">{</span><span class="s1">display:</span><span class="s6">block</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.cmpHandle</span><span class="s4">{</span><span class="s1">position:</span><span class="s6">absolute</span><span class="s4">;</span><span class="s1">top:</span><span class="s9">0</span><span class="s4">;</span><span class="s1">bottom:</span><span class="s9">0</span><span class="s4">;</span><span class="s1">width:</span><span class="s9">2px</span><span class="s4">;</span><span class="s1">background:</span><span class="s10">#0aa</span><span class="s4">;</span><span class="s1">box-shadow:</span><span class="s9">0</span><span class="s4"> </span><span class="s9">0</span><span class="s4"> </span><span class="s9">0</span><span class="s4"> </span><span class="s9">1px</span><span class="s4"> </span><span class="s10">#0aa</span><span class="s4">}</span></p>
<p class="p9"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s1">.cmpBar</span><span class="s4">{</span><span class="s7">width:</span><span class="s9">100%</span><span class="s4">}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s1">/* ズームビュー（等倍） */</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.zoomBox</span><span class="s4">{</span><span class="s1">position:</span><span class="s6">relative</span><span class="s4">;</span><span class="s1">border:</span><span class="s9">1px</span><span class="s4"> </span><span class="s6">solid</span><span class="s4"> </span><span class="s10">#ddd</span><span class="s4">;</span><span class="s1">background:</span><span class="s10">#fff</span><span class="s4">;</span><span class="s1">touch-action:</span><span class="s6">none</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.zoomHint</span><span class="s4">{</span><span class="s1">position:</span><span class="s6">absolute</span><span class="s4">;</span><span class="s1">right:</span><span class="s9">6px</span><span class="s4">;</span><span class="s1">bottom:</span><span class="s9">6px</span><span class="s4">;</span><span class="s1">background:</span><span class="s10">#0008</span><span class="s4">;</span><span class="s1">color:</span><span class="s10">#fff</span><span class="s4">;</span><span class="s1">font-size:</span><span class="s9">11px</span><span class="s4">;</span><span class="s1">padding:</span><span class="s9">2px</span><span class="s4"> </span><span class="s9">6px</span><span class="s4">;</span><span class="s1">border-radius:</span><span class="s9">4px</span><span class="s4">}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s1">/* details/summary（オプション折りたたみ） */</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">details</span><span class="s4">{</span><span class="s1">border:</span><span class="s9">1px</span><span class="s4"> </span><span class="s6">solid</span><span class="s4"> </span><span class="s10">#e5e5e5</span><span class="s4">;</span><span class="s1">border-radius:</span><span class="s9">6px</span><span class="s4">;</span><span class="s1">padding:</span><span class="s9">8px</span><span class="s4"> </span><span class="s9">10px</span><span class="s4">;</span><span class="s1">background:</span><span class="s10">#fafafa</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">details</span><span class="s4">&gt;</span><span class="s8">summary</span><span class="s4">{</span><span class="s1">cursor:</span><span class="s6">pointer</span><span class="s4">;</span><span class="s1">list-style:</span><span class="s6">none</span><span class="s4">}</span></p>
<p class="p9"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s1">details</span><span class="s4">&gt;</span><span class="s1">summary::-webkit-details-marker</span><span class="s4">{</span><span class="s7">display:</span><span class="s6">none</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.sumRow</span><span class="s4">{</span><span class="s1">display:</span><span class="s6">flex</span><span class="s4">;</span><span class="s1">align-items:</span><span class="s6">center</span><span class="s4">;</span><span class="s1">gap:</span><span class="s9">8px</span><span class="s4">}</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s8">.sumRow</span><span class="s4"> </span><span class="s8">.pill</span><span class="s4">{</span><span class="s1">background:</span><span class="s10">#eef8f7</span><span class="s4">;</span><span class="s1">color:</span><span class="s10">#066</span><span class="s4">;</span><span class="s1">padding:</span><span class="s9">2px</span><span class="s4"> </span><span class="s9">6px</span><span class="s4">;</span><span class="s1">border-radius:</span><span class="s9">999px</span><span class="s4">;</span><span class="s1">font-size:</span><span class="s9">11px</span><span class="s4">}</span></p>
<p class="p2"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s3">&lt;/</span><span class="s1">style</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;/</span><span class="s1">head</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;</span><span class="s1">body</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s3">&lt;</span><span class="s5">h3</span><span class="s3">&gt;</span><span class="s1">画像一括ダウンロードツール</span><span class="s3">&lt;/</span><span class="s5">h3</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p2"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s3">&lt;</span><span class="s1">form</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s6">"f"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"section"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">label</span><span class="s3">&gt;</span><span class="s1">キーワード</span><span class="s3">&lt;/</span><span class="s5">label</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">input</span><span class="s4"> </span><span class="s1">type</span><span class="s3">=</span><span class="s6">"text"</span><span class="s4"> </span><span class="s1">name</span><span class="s3">=</span><span class="s6">"keyword"</span><span class="s4"> </span><span class="s1">placeholder</span><span class="s3">=</span><span class="s6">"例: tech"</span><span class="s4"> </span><span class="s1">required</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">label</span><span class="s3">&gt;</span><span class="s1">公開日 (YYYYMMDD)</span><span class="s3">&lt;/</span><span class="s5">label</span><span class="s3">&gt;</span></p>
<p class="p3"><span class="s4"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">input</span><span class="s4"> </span><span class="s1">type</span><span class="s3">=</span><span class="s6">"text"</span><span class="s4"> </span><span class="s1">name</span><span class="s3">=</span><span class="s6">"date"</span><span class="s4"> </span><span class="s1">placeholder</span><span class="s3">=</span><span class="s6">"例: 20250823"</span><span class="s4"> </span><span class="s1">pattern</span><span class="s3">=</span><span class="s6">"[0-9]{8}"</span><span class="s4"> </span><span class="s1">inputmode</span><span class="s3">=</span><span class="s6">"numeric"</span><span class="s4"> </span><span class="s1">maxlength</span><span class="s3">=</span><span class="s6">"8"</span><span class="s4"> </span><span class="s1">autocomplete</span><span class="s3">=</span><span class="s6">"off"</span><span class="s4"> </span><span class="s1">required</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;!-- 基本設定（シンプル） --&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"section grid-2"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">label</span><span class="s3">&gt;</span><span class="s1">リサイズ</span><span class="s3">&lt;/</span><span class="s5">label</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">select</span><span class="s4"> </span><span class="s7">name</span><span class="s3">=</span><span class="s1">"resizeMode"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;</span><span class="s5">option</span><span class="s1"> </span><span class="s7">value</span><span class="s3">=</span><span class="s6">"width"</span><span class="s3">&gt;</span><span class="s1">幅指定（px）</span><span class="s3">&lt;/</span><span class="s5">option</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;</span><span class="s5">option</span><span class="s1"> </span><span class="s7">value</span><span class="s3">=</span><span class="s6">"none"</span><span class="s3">&gt;</span><span class="s1">リサイズしない</span><span class="s3">&lt;/</span><span class="s5">option</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;/</span><span class="s5">select</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"widthRow"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">label</span><span class="s3">&gt;</span><span class="s1">出力幅 (px)</span><span class="s3">&lt;/</span><span class="s5">label</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">input</span><span class="s4"> </span><span class="s7">type</span><span class="s3">=</span><span class="s1">"number"</span><span class="s4"> </span><span class="s7">name</span><span class="s3">=</span><span class="s1">"targetW"</span><span class="s4"> </span><span class="s7">min</span><span class="s3">=</span><span class="s1">"64"</span><span class="s4"> </span><span class="s7">step</span><span class="s3">=</span><span class="s1">"1"</span><span class="s4"> </span><span class="s7">value</span><span class="s3">=</span><span class="s1">"768"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;!-- 詳細オプション（折りたたみ） --&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"section"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">details</span><span class="s1"> </span><span class="s7">id</span><span class="s3">=</span><span class="s6">"adv"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">summary</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s1"> </span><span class="s7">class</span><span class="s3">=</span><span class="s6">"sumRow"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s5">strong</span><span class="s3">&gt;</span><span class="s1">詳細オプション</span><span class="s3">&lt;/</span><span class="s5">strong</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s5">span</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"pill"</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"advSummary"</span><span class="s3">&gt;</span><span class="s4">既定</span><span class="s3">&lt;/</span><span class="s5">span</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s1"> </span><span class="s7">class</span><span class="s3">=</span><span class="s6">"muted"</span><span class="s3">&gt;</span><span class="s1">必要な場合のみ開いて調整してください</span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;/</span><span class="s5">summary</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"section grid-2"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s5">label</span><span class="s3">&gt;</span><span class="s1">JPEG品質 (0.80–1.00)</span><span class="s3">&lt;/</span><span class="s5">label</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s5">input</span><span class="s4"> </span><span class="s7">type</span><span class="s3">=</span><span class="s1">"number"</span><span class="s4"> </span><span class="s7">name</span><span class="s3">=</span><span class="s1">"quality"</span><span class="s4"> </span><span class="s7">min</span><span class="s3">=</span><span class="s1">"0.8"</span><span class="s4"> </span><span class="s7">max</span><span class="s3">=</span><span class="s1">"1.0"</span><span class="s4"> </span><span class="s7">step</span><span class="s3">=</span><span class="s1">"0.01"</span><span class="s4"> </span><span class="s7">value</span><span class="s3">=</span><span class="s1">"0.95"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s5">label</span><span class="s3">&gt;</span><span class="s1">シャープ補正 a (0–1)</span><span class="s3">&lt;/</span><span class="s5">label</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s5">input</span><span class="s4"> </span><span class="s7">type</span><span class="s3">=</span><span class="s1">"number"</span><span class="s4"> </span><span class="s7">name</span><span class="s3">=</span><span class="s1">"sharpen"</span><span class="s4"> </span><span class="s7">min</span><span class="s3">=</span><span class="s1">"0"</span><span class="s4"> </span><span class="s7">max</span><span class="s3">=</span><span class="s1">"1"</span><span class="s4"> </span><span class="s7">step</span><span class="s3">=</span><span class="s1">"0.05"</span><span class="s4"> </span><span class="s7">value</span><span class="s3">=</span><span class="s1">"0.15"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"grid-3 section"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s5">label</span><span class="s3">&gt;</span><span class="s1">ノイズ低減（事前ぼかし）(0–2px)</span><span class="s3">&lt;/</span><span class="s5">label</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s5">input</span><span class="s4"> </span><span class="s7">type</span><span class="s3">=</span><span class="s1">"number"</span><span class="s4"> </span><span class="s7">name</span><span class="s3">=</span><span class="s1">"denoise"</span><span class="s4"> </span><span class="s7">min</span><span class="s3">=</span><span class="s1">"0"</span><span class="s4"> </span><span class="s7">max</span><span class="s3">=</span><span class="s1">"2"</span><span class="s4"> </span><span class="s7">step</span><span class="s3">=</span><span class="s1">"0.1"</span><span class="s4"> </span><span class="s7">value</span><span class="s3">=</span><span class="s1">"0"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s5">label</span><span class="s3">&gt;</span><span class="s1">リサンプル方法</span><span class="s3">&lt;/</span><span class="s5">label</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s5">select</span><span class="s1"> </span><span class="s7">name</span><span class="s3">=</span><span class="s6">"resample"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">              </span></span><span class="s3">&lt;</span><span class="s5">option</span><span class="s1"> </span><span class="s7">value</span><span class="s3">=</span><span class="s6">"auto"</span><span class="s3">&gt;</span><span class="s1">Auto（ブラウザ高品質）</span><span class="s3">&lt;/</span><span class="s5">option</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">              </span></span><span class="s3">&lt;</span><span class="s5">option</span><span class="s1"> </span><span class="s7">value</span><span class="s3">=</span><span class="s6">"progressive"</span><span class="s3">&gt;</span><span class="s1">段階縮小（強い縮小に有効）</span><span class="s3">&lt;/</span><span class="s5">option</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;/</span><span class="s5">select</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s5">label</span><span class="s3">&gt;</span><span class="s1">プレビュー比較モード</span><span class="s3">&lt;/</span><span class="s5">label</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;</span><span class="s5">select</span><span class="s1"> </span><span class="s7">id</span><span class="s3">=</span><span class="s6">"modeSelect"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">              </span></span><span class="s3">&lt;</span><span class="s5">option</span><span class="s1"> </span><span class="s7">value</span><span class="s3">=</span><span class="s6">"side"</span><span class="s3">&gt;</span><span class="s1">並べて比較</span><span class="s3">&lt;/</span><span class="s5">option</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">              </span></span><span class="s3">&lt;</span><span class="s5">option</span><span class="s1"> </span><span class="s7">value</span><span class="s3">=</span><span class="s6">"slider"</span><span class="s3">&gt;</span><span class="s1">比較スライダー</span><span class="s3">&lt;/</span><span class="s5">option</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">              </span></span><span class="s3">&lt;</span><span class="s5">option</span><span class="s1"> </span><span class="s7">value</span><span class="s3">=</span><span class="s6">"zoom"</span><span class="s3">&gt;</span><span class="s1">等倍(1:1)ズーム</span><span class="s3">&lt;/</span><span class="s5">option</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">            </span></span><span class="s3">&lt;/</span><span class="s5">select</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s4"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;/</span><span class="s1">details</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s1"> </span><span class="s7">class</span><span class="s3">=</span><span class="s6">"muted"</span><span class="s3">&gt;</span><span class="s1">出力例: </span><span class="s3">&lt;</span><span class="s5">code</span><span class="s3">&gt;</span><span class="s1">img-keyword-YYYYMMDD-01.jpg</span><span class="s3">&lt;/</span><span class="s5">code</span><span class="s3">&gt;</span><span class="s1">（拡張子は .jpg）</span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s1"> </span><span class="s7">class</span><span class="s3">=</span><span class="s6">"section"</span><span class="s3">&gt;&lt;</span><span class="s5">button</span><span class="s1"> </span><span class="s7">type</span><span class="s3">=</span><span class="s6">"submit"</span><span class="s3">&gt;</span><span class="s1">一括エクスポート（ZIPを保存）</span><span class="s3">&lt;/</span><span class="s5">button</span><span class="s3">&gt;&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s3">&lt;/</span><span class="s1">form</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">&lt;!-- プレビュー --&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"previewWrap"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"previewHead"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s4"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s1">strong</span><span class="s3">&gt;</span><span class="s4">プレビュー</span><span class="s3">&lt;/</span><span class="s1">strong</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">span</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"badge"</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"pvMeta"</span><span class="s3">&gt;</span><span class="s4">未読込</span><span class="s3">&lt;/</span><span class="s5">span</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">style</span><span class="s3">=</span><span class="s1">"flex:1 0 140px"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"pvControls"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;</span><span class="s5">input</span><span class="s4"> </span><span class="s7">type</span><span class="s3">=</span><span class="s1">"range"</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"pvIndex"</span><span class="s4"> </span><span class="s7">min</span><span class="s3">=</span><span class="s1">"1"</span><span class="s4"> </span><span class="s7">max</span><span class="s3">=</span><span class="s1">"1"</span><span class="s4"> </span><span class="s7">value</span><span class="s3">=</span><span class="s1">"1"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"muted"</span><span class="s4"> </span><span class="s7">style</span><span class="s3">=</span><span class="s1">"text-align:right"</span><span class="s3">&gt;&lt;</span><span class="s5">span</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"pvIndexLabel"</span><span class="s3">&gt;</span><span class="s4">1 / 1</span><span class="s3">&lt;/</span><span class="s5">span</span><span class="s3">&gt;&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">style</span><span class="s3">=</span><span class="s1">"display:flex;gap:6px;width:100%"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">button</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"btnPrev"</span><span class="s4"> </span><span class="s7">type</span><span class="s3">=</span><span class="s1">"button"</span><span class="s4"> </span><span class="s7">style</span><span class="s3">=</span><span class="s1">"flex:1"</span><span class="s3">&gt;</span><span class="s4">◀ 前へ</span><span class="s3">&lt;/</span><span class="s5">button</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">button</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"btnLoadPrev"</span><span class="s4"> </span><span class="s7">type</span><span class="s3">=</span><span class="s1">"button"</span><span class="s4"> </span><span class="s7">style</span><span class="s3">=</span><span class="s1">"flex:1"</span><span class="s3">&gt;</span><span class="s4">プレビュー読み込み</span><span class="s3">&lt;/</span><span class="s5">button</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">button</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"btnNext"</span><span class="s4"> </span><span class="s7">type</span><span class="s3">=</span><span class="s1">"button"</span><span class="s4"> </span><span class="s7">style</span><span class="s3">=</span><span class="s1">"flex:1"</span><span class="s3">&gt;</span><span class="s4">次へ ▶</span><span class="s3">&lt;/</span><span class="s5">button</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;!-- サイドバイサイド --&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"pvSideBySide section"</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"modeSide"</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s4"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s1">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s6">"pvBox"</span><span class="s3">&gt;&lt;</span><span class="s1">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s6">"muted"</span><span class="s3">&gt;</span><span class="s4">原画像（表示用に縮小）</span><span class="s3">&lt;/</span><span class="s1">div</span><span class="s3">&gt;&lt;</span><span class="s1">canvas</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s6">"pvSrc"</span><span class="s3">&gt;&lt;/</span><span class="s1">canvas</span><span class="s3">&gt;&lt;/</span><span class="s1">div</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s4"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s1">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s6">"pvBox"</span><span class="s3">&gt;&lt;</span><span class="s1">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s6">"muted"</span><span class="s3">&gt;</span><span class="s4">出力プレビュー</span><span class="s3">&lt;/</span><span class="s1">div</span><span class="s3">&gt;&lt;</span><span class="s1">canvas</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s6">"pvDst"</span><span class="s3">&gt;&lt;/</span><span class="s1">canvas</span><span class="s3">&gt;&lt;/</span><span class="s1">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;!-- 比較スライダー --&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"section"</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"modeSlider"</span><span class="s4"> </span><span class="s7">style</span><span class="s3">=</span><span class="s1">"display:none"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"cmpWrap"</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"cmpWrap"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">canvas</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"cmpBase"</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"cmpBase"</span><span class="s3">&gt;&lt;/</span><span class="s5">canvas</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"cmpMask"</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"cmpMask"</span><span class="s4"> </span><span class="s7">style</span><span class="s3">=</span><span class="s1">"width:50%"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">          </span></span><span class="s3">&lt;</span><span class="s5">canvas</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"cmpTop"</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"cmpTop"</span><span class="s3">&gt;&lt;/</span><span class="s5">canvas</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"cmpHandle"</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"cmpHandle"</span><span class="s4"> </span><span class="s7">style</span><span class="s3">=</span><span class="s1">"left:50%"</span><span class="s3">&gt;&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">input</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"cmpRange"</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"cmpBar"</span><span class="s4"> </span><span class="s7">type</span><span class="s3">=</span><span class="s1">"range"</span><span class="s4"> </span><span class="s7">min</span><span class="s3">=</span><span class="s1">"0"</span><span class="s4"> </span><span class="s7">max</span><span class="s3">=</span><span class="s1">"100"</span><span class="s4"> </span><span class="s7">value</span><span class="s3">=</span><span class="s1">"50"</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s1"> </span><span class="s7">class</span><span class="s3">=</span><span class="s6">"muted"</span><span class="s3">&gt;</span><span class="s1">左：原画像 / 右：出力（バーを動かして比較）</span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p5"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s1">&lt;!-- ズームモード --&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"section"</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"modeZoom"</span><span class="s4"> </span><span class="s7">style</span><span class="s3">=</span><span class="s1">"display:none"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"zoomBox"</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"zoomBox"</span><span class="s4"> </span><span class="s7">style</span><span class="s3">=</span><span class="s1">"width:100%"</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">canvas</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"zoomCanvas"</span><span class="s3">&gt;&lt;/</span><span class="s5">canvas</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s1"> </span><span class="s7">class</span><span class="s3">=</span><span class="s6">"zoomHint"</span><span class="s3">&gt;</span><span class="s1">ドラッグで移動 / ホイールで拡大縮小</span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s1"> </span><span class="s7">class</span><span class="s3">=</span><span class="s6">"muted"</span><span class="s3">&gt;</span><span class="s1">表示は出力画像です（品質はそのまま）。</span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s3">&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s3">&lt;/</span><span class="s1">div</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"status"</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"small section"</span><span class="s3">&gt;&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s3">&lt;</span><span class="s5">progress</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"bar"</span><span class="s4"> </span><span class="s7">max</span><span class="s3">=</span><span class="s1">"100"</span><span class="s4"> </span><span class="s7">value</span><span class="s3">=</span><span class="s1">"0"</span><span class="s4"> </span><span class="s7">style</span><span class="s3">=</span><span class="s1">"display:none"</span><span class="s3">&gt;&lt;/</span><span class="s5">progress</span><span class="s3">&gt;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s3">&lt;</span><span class="s5">div</span><span class="s4"> </span><span class="s7">id</span><span class="s3">=</span><span class="s1">"out"</span><span class="s4"> </span><span class="s7">class</span><span class="s3">=</span><span class="s1">"section"</span><span class="s3">&gt;&lt;/</span><span class="s5">div</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p2"><span class="s3">&lt;</span><span class="s1">script</span><span class="s3">&gt;</span></p>
<p class="p10"><span class="s5">const</span><span class="s4"> </span><span class="s1">$</span><span class="s4"> = </span><span class="s1">s</span><span class="s4"> =&gt; </span><span class="s1">document</span><span class="s4">.</span><span class="s1">querySelector</span><span class="s4">(</span><span class="s1">s</span><span class="s4">);</span></p>
<p class="p10"><span class="s5">const</span><span class="s4"> </span><span class="s1">sleep</span><span class="s4"> = </span><span class="s1">ms</span><span class="s4"> =&gt; </span><span class="s5">new</span><span class="s4"> </span><span class="s12">Promise</span><span class="s4">(</span><span class="s1">r</span><span class="s4"> =&gt; </span><span class="s1">setTimeout</span><span class="s4">(</span><span class="s1">r</span><span class="s4">, </span><span class="s1">ms</span><span class="s4">));</span></p>
<p class="p4"><span class="s5">const</span><span class="s1"> </span><span class="s13">debounce</span><span class="s1"> = (</span><span class="s13">fn</span><span class="s1">, </span><span class="s13">d</span><span class="s1">=</span><span class="s7">150</span><span class="s1">) =&gt; { </span><span class="s5">let</span><span class="s1"> </span><span class="s13">t</span><span class="s1">; </span><span class="s5">return</span><span class="s1"> (...</span><span class="s13">a</span><span class="s1">)=&gt;{ </span><span class="s13">clearTimeout</span><span class="s1">(</span><span class="s13">t</span><span class="s1">); </span><span class="s13">t</span><span class="s1">=</span><span class="s13">setTimeout</span><span class="s1">(()=&gt;</span><span class="s13">fn</span><span class="s1">(...</span><span class="s13">a</span><span class="s1">), </span><span class="s13">d</span><span class="s1">); } };</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s1">// 公開日 正規化（全角→半角、数字以外除去、8桁）</span></p>
<p class="p10"><span class="s5">const</span><span class="s4"> </span><span class="s1">dateI</span><span class="s4"> = </span><span class="s1">document</span><span class="s4">.</span><span class="s1">querySelector</span><span class="s4">(</span><span class="s6">'input[name="date"]'</span><span class="s4">);</span></p>
<p class="p10"><span class="s1">dateI</span><span class="s4">.</span><span class="s1">addEventListener</span><span class="s4">(</span><span class="s6">'input'</span><span class="s4">, </span><span class="s1">e</span><span class="s4"> =&gt; {</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">let</span><span class="s4"> </span><span class="s1">v</span><span class="s4"> = </span><span class="s1">e</span><span class="s4">.</span><span class="s1">target</span><span class="s4">.</span><span class="s1">value</span><span class="s4">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">v</span><span class="s4"> = </span><span class="s1">v</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(</span><span class="s8">/[０-９]/</span><span class="s5">g</span><span class="s4">, </span><span class="s1">ch</span><span class="s4"> =&gt; </span><span class="s12">String</span><span class="s4">.</span><span class="s1">fromCharCode</span><span class="s4">(</span><span class="s1">ch</span><span class="s4">.</span><span class="s1">charCodeAt</span><span class="s4">(</span><span class="s7">0</span><span class="s4">) - </span><span class="s14">0xFEE0</span><span class="s4">));</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s13">v</span><span class="s1"> = </span><span class="s13">v</span><span class="s1">.</span><span class="s13">replace</span><span class="s1">(</span><span class="s8">/[^0-9]/</span><span class="s5">g</span><span class="s1">, </span><span class="s6">''</span><span class="s1">).</span><span class="s13">slice</span><span class="s1">(</span><span class="s7">0</span><span class="s1">, </span><span class="s7">8</span><span class="s1">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">e</span><span class="s4">.</span><span class="s1">target</span><span class="s4">.</span><span class="s1">value</span><span class="s4"> = </span><span class="s1">v</span><span class="s4">;</span></p>
<p class="p4"><span class="s1">});</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s1">// リサイズモードで幅入力の有効/無効切替</span></p>
<p class="p10"><span class="s5">const</span><span class="s4"> </span><span class="s1">resizeSelect</span><span class="s4"> = </span><span class="s1">document</span><span class="s4">.</span><span class="s1">querySelector</span><span class="s4">(</span><span class="s6">'select[name="resizeMode"]'</span><span class="s4">);</span></p>
<p class="p6"><span class="s5">const</span><span class="s4"> </span><span class="s13">widthRow</span><span class="s4"> = </span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#widthRow'</span><span class="s4">);</span></p>
<p class="p10"><span class="s5">function</span><span class="s4"> </span><span class="s1">updateWidthRow</span><span class="s4">(){ </span><span class="s1">widthRow</span><span class="s4">.</span><span class="s1">style</span><span class="s4">.</span><span class="s1">display</span><span class="s4"> = </span><span class="s1">resizeSelect</span><span class="s4">.</span><span class="s1">value</span><span class="s4"> === </span><span class="s6">'none'</span><span class="s4"> ? </span><span class="s6">'none'</span><span class="s4"> : </span><span class="s6">''</span><span class="s4">; }</span></p>
<p class="p10"><span class="s1">resizeSelect</span><span class="s4">.</span><span class="s1">addEventListener</span><span class="s4">(</span><span class="s6">'change'</span><span class="s4">, </span><span class="s1">updateWidthRow</span><span class="s4">); </span><span class="s1">updateWidthRow</span><span class="s4">();</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s1">// 詳細オプションの要約（summary）表示を更新</span></p>
<p class="p4"><span class="s5">const</span><span class="s1"> </span><span class="s13">adv</span><span class="s1"> = </span><span class="s13">$</span><span class="s1">(</span><span class="s6">'#adv'</span><span class="s1">);</span></p>
<p class="p6"><span class="s5">const</span><span class="s4"> </span><span class="s13">advSummary</span><span class="s4"> = </span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#advSummary'</span><span class="s4">);</span></p>
<p class="p10"><span class="s5">function</span><span class="s4"> </span><span class="s1">refreshAdvSummary</span><span class="s4">(){</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">q</span><span class="s4"> = </span><span class="s12">Number</span><span class="s4">(</span><span class="s1">document</span><span class="s4">.</span><span class="s1">querySelector</span><span class="s4">(</span><span class="s6">'[name="quality"]'</span><span class="s4">).</span><span class="s1">value</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">s</span><span class="s4"> = </span><span class="s12">Number</span><span class="s4">(</span><span class="s1">document</span><span class="s4">.</span><span class="s1">querySelector</span><span class="s4">(</span><span class="s6">'[name="sharpen"]'</span><span class="s4">).</span><span class="s1">value</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">d</span><span class="s4"> = </span><span class="s12">Number</span><span class="s4">(</span><span class="s1">document</span><span class="s4">.</span><span class="s1">querySelector</span><span class="s4">(</span><span class="s6">'[name="denoise"]'</span><span class="s4">).</span><span class="s1">value</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">r</span><span class="s4"> = </span><span class="s1">document</span><span class="s4">.</span><span class="s1">querySelector</span><span class="s4">(</span><span class="s6">'[name="resample"]'</span><span class="s4">).</span><span class="s1">value</span><span class="s4">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s1"> </span><span class="s13">parts</span><span class="s1"> = [];</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s5">if</span><span class="s1"> (</span><span class="s13">q</span><span class="s1"> !== </span><span class="s7">0.95</span><span class="s1">) </span><span class="s13">parts</span><span class="s1">.</span><span class="s13">push</span><span class="s1">(</span><span class="s6">`Q:</span><span class="s1">${</span><span class="s13">q</span><span class="s1">.</span><span class="s13">toFixed</span><span class="s1">(</span><span class="s7">2</span><span class="s1">)}</span><span class="s6">`</span><span class="s1">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s5">if</span><span class="s1"> (</span><span class="s13">s</span><span class="s1"> !== </span><span class="s7">0.15</span><span class="s1">) </span><span class="s13">parts</span><span class="s1">.</span><span class="s13">push</span><span class="s1">(</span><span class="s6">`S:</span><span class="s1">${</span><span class="s13">s</span><span class="s1">}</span><span class="s6">`</span><span class="s1">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s5">if</span><span class="s1"> (</span><span class="s13">d</span><span class="s1"> !== </span><span class="s7">0</span><span class="s1">) </span><span class="s13">parts</span><span class="s1">.</span><span class="s13">push</span><span class="s1">(</span><span class="s6">`D:</span><span class="s1">${</span><span class="s13">d</span><span class="s1">}</span><span class="s6">`</span><span class="s1">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s5">if</span><span class="s1"> (</span><span class="s13">r</span><span class="s1"> !== </span><span class="s6">'auto'</span><span class="s1">) </span><span class="s13">parts</span><span class="s1">.</span><span class="s13">push</span><span class="s1">(</span><span class="s6">`R:</span><span class="s1">${</span><span class="s13">r</span><span class="s1">}</span><span class="s6">`</span><span class="s1">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">advSummary</span><span class="s4">.</span><span class="s1">textContent</span><span class="s4"> = </span><span class="s1">parts</span><span class="s4">.</span><span class="s1">length</span><span class="s4"> ? </span><span class="s1">parts</span><span class="s4">.</span><span class="s1">join</span><span class="s4">(</span><span class="s6">' / '</span><span class="s4">) : </span><span class="s6">'既定'</span><span class="s4">;</span></p>
<p class="p4"><span class="s1">}</span></p>
<p class="p10"><span class="s1">adv</span><span class="s4">.</span><span class="s1">addEventListener</span><span class="s4">(</span><span class="s6">'toggle'</span><span class="s4">, </span><span class="s1">refreshAdvSummary</span><span class="s4">);</span></p>
<p class="p10"><span class="s4">[</span><span class="s6">'quality'</span><span class="s4">,</span><span class="s6">'sharpen'</span><span class="s4">,</span><span class="s6">'denoise'</span><span class="s4">,</span><span class="s6">'resample'</span><span class="s4">].</span><span class="s1">forEach</span><span class="s4">(</span><span class="s1">n</span><span class="s4">=&gt;</span><span class="s1">document</span><span class="s4">.</span><span class="s1">querySelector</span><span class="s4">(</span><span class="s6">`[name="</span><span class="s4">${</span><span class="s1">n</span><span class="s4">}</span><span class="s6">"]`</span><span class="s4">).</span><span class="s1">addEventListener</span><span class="s4">(</span><span class="s6">'input'</span><span class="s4">, </span><span class="s1">debounce</span><span class="s4">(</span><span class="s1">refreshAdvSummary</span><span class="s4">,</span><span class="s7">150</span><span class="s4">)));</span></p>
<p class="p10"><span class="s1">refreshAdvSummary</span><span class="s4">();</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s1">// —— 一括エクスポート —— //</span></p>
<p class="p10"><span class="s1">$</span><span class="s4">(</span><span class="s6">'#f'</span><span class="s4">).</span><span class="s1">addEventListener</span><span class="s4">(</span><span class="s6">'submit'</span><span class="s4">, </span><span class="s5">async</span><span class="s4"> (</span><span class="s1">e</span><span class="s4">) =&gt; {</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">e</span><span class="s4">.</span><span class="s1">preventDefault</span><span class="s4">();</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#out'</span><span class="s4">).</span><span class="s1">innerHTML</span><span class="s4">=</span><span class="s6">''</span><span class="s4">; </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#status'</span><span class="s4">).</span><span class="s1">textContent</span><span class="s4">=</span><span class="s6">''</span><span class="s4">; </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#bar'</span><span class="s4">).</span><span class="s1">style</span><span class="s4">.</span><span class="s1">display</span><span class="s4">=</span><span class="s6">'block'</span><span class="s4">; </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#bar'</span><span class="s4">).</span><span class="s1">value</span><span class="s4">=</span><span class="s7">0</span><span class="s4">;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s13">btn</span><span class="s4"> = </span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#f button[type="submit"]'</span><span class="s4">); </span><span class="s13">btn</span><span class="s4">.</span><span class="s13">disabled</span><span class="s4">=</span><span class="s5">true</span><span class="s4">; </span><span class="s13">btn</span><span class="s4">.</span><span class="s13">textContent</span><span class="s4">=</span><span class="s1">'処理中…'</span><span class="s4">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s5">try</span><span class="s1"> {</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">o</span><span class="s4"> = </span><span class="s1">readOptions</span><span class="s4">();</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s5">if</span><span class="s4"> (!</span><span class="s13">o</span><span class="s4">.</span><span class="s13">keyword</span><span class="s4"> || !</span><span class="s8">/^[0-9]{8}$/</span><span class="s4">.</span><span class="s13">test</span><span class="s4">(</span><span class="s13">o</span><span class="s4">.</span><span class="s13">date</span><span class="s4">)) </span><span class="s5">throw</span><span class="s4"> </span><span class="s5">new</span><span class="s4"> </span><span class="s12">Error</span><span class="s4">(</span><span class="s1">'キーワードと公開日(YYYYMMDD)を正しく入力してください。'</span><span class="s4">);</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s5">const</span><span class="s4"> </span><span class="s13">total</span><span class="s4"> = </span><span class="s5">await</span><span class="s4"> </span><span class="s13">call</span><span class="s4">(</span><span class="s1">'countImages'</span><span class="s4">);</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s5">if</span><span class="s4"> (!</span><span class="s13">total</span><span class="s4">){ </span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#status'</span><span class="s4">).</span><span class="s13">textContent</span><span class="s4">=</span><span class="s1">'画像が見つかりませんでした。'</span><span class="s4">; </span><span class="s5">return</span><span class="s4">; }</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s5">const</span><span class="s1"> </span><span class="s13">batchSize</span><span class="s1"> = </span><span class="s7">8</span><span class="s1">; </span><span class="s5">const</span><span class="s1"> </span><span class="s13">zip</span><span class="s1"> = </span><span class="s5">new</span><span class="s1"> </span><span class="s12">JSZip</span><span class="s1">(); </span><span class="s5">let</span><span class="s1"> </span><span class="s13">processed</span><span class="s1">=</span><span class="s7">0</span><span class="s1">, </span><span class="s13">seq</span><span class="s1">=</span><span class="s7">1</span><span class="s1">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s5">for</span><span class="s4"> (</span><span class="s5">let</span><span class="s4"> </span><span class="s1">offset</span><span class="s4">=</span><span class="s7">0</span><span class="s4">; </span><span class="s1">offset</span><span class="s4">&lt;</span><span class="s1">total</span><span class="s4">; </span><span class="s1">offset</span><span class="s4">+=</span><span class="s1">batchSize</span><span class="s4">){</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">      </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">pack</span><span class="s4"> = </span><span class="s5">await</span><span class="s4"> </span><span class="s1">call</span><span class="s4">(</span><span class="s6">'getImagesBatch'</span><span class="s4">, </span><span class="s1">offset</span><span class="s4">, </span><span class="s1">batchSize</span><span class="s4">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s5">for</span><span class="s1"> (</span><span class="s5">const</span><span class="s1"> </span><span class="s13">it</span><span class="s1"> </span><span class="s5">of</span><span class="s1"> </span><span class="s13">pack</span><span class="s1">.</span><span class="s13">items</span><span class="s1">){</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s5">const</span><span class="s1"> </span><span class="s13">nn</span><span class="s1"> = </span><span class="s12">String</span><span class="s1">(</span><span class="s13">seq</span><span class="s1">++).</span><span class="s13">padStart</span><span class="s1">(</span><span class="s7">2</span><span class="s1">,</span><span class="s6">'0'</span><span class="s1">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s5">const</span><span class="s1"> </span><span class="s13">fname</span><span class="s1"> = </span><span class="s6">`img-</span><span class="s1">${</span><span class="s13">o</span><span class="s1">.</span><span class="s13">keyword</span><span class="s1">}</span><span class="s6">-</span><span class="s1">${</span><span class="s13">o</span><span class="s1">.</span><span class="s13">date</span><span class="s1">}</span><span class="s6">-</span><span class="s1">${</span><span class="s13">nn</span><span class="s1">}</span><span class="s6">.jpg`</span><span class="s1">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">blob</span><span class="s4"> = </span><span class="s5">await</span><span class="s4"> </span><span class="s1">convertWithOptions</span><span class="s4">(</span><span class="s1">it</span><span class="s4">.</span><span class="s1">b64</span><span class="s4">, </span><span class="s1">it</span><span class="s4">.</span><span class="s1">mime</span><span class="s4">, </span><span class="s1">o</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s1">zip</span><span class="s4">.</span><span class="s1">file</span><span class="s4">(</span><span class="s1">fname</span><span class="s4">, </span><span class="s1">blob</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">        </span></span><span class="s1">processed</span><span class="s4">++; </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#status'</span><span class="s4">).</span><span class="s1">textContent</span><span class="s4">=</span><span class="s6">`処理中… </span><span class="s4">${</span><span class="s1">processed</span><span class="s4">}</span><span class="s6"> / </span><span class="s4">${</span><span class="s1">total</span><span class="s4">}</span><span class="s6">`</span><span class="s4">; </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#bar'</span><span class="s4">).</span><span class="s1">value</span><span class="s4"> = </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">round</span><span class="s4">((</span><span class="s1">processed</span><span class="s4">/</span><span class="s1">total</span><span class="s4">)*</span><span class="s7">100</span><span class="s4">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s5">await</span><span class="s1"> </span><span class="s13">sleep</span><span class="s1">(</span><span class="s7">5</span><span class="s1">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">zipName</span><span class="s4"> = </span><span class="s6">`img-</span><span class="s4">${</span><span class="s1">o</span><span class="s4">.</span><span class="s1">keyword</span><span class="s4">}</span><span class="s6">-</span><span class="s4">${</span><span class="s1">o</span><span class="s4">.</span><span class="s1">date</span><span class="s4">}</span><span class="s6">.zip`</span><span class="s4">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">zipBlob</span><span class="s4"> = </span><span class="s5">await</span><span class="s4"> </span><span class="s1">zip</span><span class="s4">.</span><span class="s1">generateAsync</span><span class="s4">({</span><span class="s1">type</span><span class="s4">:</span><span class="s6">'blob'</span><span class="s4">});</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">url</span><span class="s4"> = </span><span class="s12">URL</span><span class="s4">.</span><span class="s1">createObjectURL</span><span class="s4">(</span><span class="s1">zipBlob</span><span class="s4">); </span><span class="s5">const</span><span class="s4"> </span><span class="s1">a</span><span class="s4"> = </span><span class="s1">document</span><span class="s4">.</span><span class="s1">createElement</span><span class="s4">(</span><span class="s6">'a'</span><span class="s4">); </span><span class="s1">a</span><span class="s4">.</span><span class="s1">href</span><span class="s4">=</span><span class="s1">url</span><span class="s4">; </span><span class="s1">a</span><span class="s4">.</span><span class="s1">download</span><span class="s4">=</span><span class="s1">zipName</span><span class="s4">; </span><span class="s1">a</span><span class="s4">.</span><span class="s1">click</span><span class="s4">(); </span><span class="s1">setTimeout</span><span class="s4">(()=&gt;</span><span class="s12">URL</span><span class="s4">.</span><span class="s1">revokeObjectURL</span><span class="s4">(</span><span class="s1">url</span><span class="s4">),</span><span class="s7">60000</span><span class="s4">);</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#out'</span><span class="s4">).</span><span class="s13">innerHTML</span><span class="s4"> = </span><span class="s1">`&lt;div class="ok"&gt;完了：</span><span class="s4">${</span><span class="s13">processed</span><span class="s4">}</span><span class="s1">件の画像をZIPにまとめました（</span><span class="s4">${</span><span class="s13">zipName</span><span class="s4">}</span><span class="s1">）。&lt;/div&gt;`</span><span class="s4">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>} </span><span class="s5">catch</span><span class="s1">(</span><span class="s13">err</span><span class="s1">){</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#out'</span><span class="s4">).</span><span class="s1">innerHTML</span><span class="s4"> = </span><span class="s6">`&lt;div class="err"&gt;エラー: </span><span class="s4">${</span><span class="s1">err</span><span class="s4"> &amp;&amp; </span><span class="s1">err</span><span class="s4">.</span><span class="s1">message</span><span class="s4"> ? </span><span class="s1">err</span><span class="s4">.</span><span class="s1">message</span><span class="s4"> : </span><span class="s1">err</span><span class="s4">}</span><span class="s6">&lt;/div&gt;`</span><span class="s4">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span>} </span><span class="s5">finally</span><span class="s4"> { </span><span class="s1">btn</span><span class="s4">.</span><span class="s1">disabled</span><span class="s4">=</span><span class="s5">false</span><span class="s4">; </span><span class="s1">btn</span><span class="s4">.</span><span class="s1">textContent</span><span class="s4">=</span><span class="s6">'一括エクスポート（ZIPを保存）'</span><span class="s4">; </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#bar'</span><span class="s4">).</span><span class="s1">style</span><span class="s4">.</span><span class="s1">display</span><span class="s4">=</span><span class="s6">'none'</span><span class="s4">; }</span></p>
<p class="p4"><span class="s1">});</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p10"><span class="s5">function</span><span class="s4"> </span><span class="s1">readOptions</span><span class="s4">(){</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">form</span><span class="s4"> = </span><span class="s12">Object</span><span class="s4">.</span><span class="s1">fromEntries</span><span class="s4">(</span><span class="s5">new</span><span class="s4"> </span><span class="s12">FormData</span><span class="s4">(</span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#f'</span><span class="s4">)).</span><span class="s1">entries</span><span class="s4">());</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">let</span><span class="s4"> </span><span class="s1">keyword</span><span class="s4"> = (</span><span class="s1">form</span><span class="s4">.</span><span class="s1">keyword</span><span class="s4">||</span><span class="s6">''</span><span class="s4">).</span><span class="s1">trim</span><span class="s4">();</span></p>
<p class="p8"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">// ファイル名に使えない文字の置換（バックスラッシュは除外して複雑なエスケープを回避）</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">keyword</span><span class="s4"> = </span><span class="s1">keyword</span><span class="s4">.</span><span class="s1">replace</span><span class="s4">(/[</span><span class="s8">/:*?"&lt;&gt;|]/</span><span class="s5">g</span><span class="s4">,</span><span class="s6">'-'</span><span class="s4">).</span><span class="s1">replaceAll</span><span class="s4">(</span><span class="s6">' '</span><span class="s4">,</span><span class="s6">'-'</span><span class="s4">).</span><span class="s1">replaceAll</span><span class="s4">(</span><span class="s6">'　'</span><span class="s4">,</span><span class="s6">'-'</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">date</span><span class="s4"> = (</span><span class="s1">form</span><span class="s4">.</span><span class="s1">date</span><span class="s4">||</span><span class="s6">''</span><span class="s4">).</span><span class="s1">trim</span><span class="s4">();</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">quality</span><span class="s4"> = </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s7">1</span><span class="s4">, </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">0.8</span><span class="s4">, </span><span class="s12">Number</span><span class="s4">(</span><span class="s1">form</span><span class="s4">.</span><span class="s1">quality</span><span class="s4">||</span><span class="s7">0.95</span><span class="s4">)));</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">sharpen</span><span class="s4"> = </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s7">1</span><span class="s4">, </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">0</span><span class="s4">, </span><span class="s12">Number</span><span class="s4">(</span><span class="s1">form</span><span class="s4">.</span><span class="s1">sharpen</span><span class="s4">||</span><span class="s7">0.15</span><span class="s4">)));</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">denoise</span><span class="s4"> = </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s7">2</span><span class="s4">, </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">0</span><span class="s4">, </span><span class="s12">Number</span><span class="s4">(</span><span class="s1">form</span><span class="s4">.</span><span class="s1">denoise</span><span class="s4">||</span><span class="s7">0</span><span class="s4">)));</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">resample</span><span class="s4"> = </span><span class="s1">form</span><span class="s4">.</span><span class="s1">resample</span><span class="s4">||</span><span class="s6">'auto'</span><span class="s4">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">resizeMode</span><span class="s4"> = </span><span class="s1">form</span><span class="s4">.</span><span class="s1">resizeMode</span><span class="s4">||</span><span class="s6">'width'</span><span class="s4">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">targetW</span><span class="s4"> = </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">1</span><span class="s4">, </span><span class="s12">Number</span><span class="s4">(</span><span class="s1">form</span><span class="s4">.</span><span class="s1">targetW</span><span class="s4">||</span><span class="s7">768</span><span class="s4">))|</span><span class="s7">0</span><span class="s4">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">return</span><span class="s4"> {</span><span class="s1">keyword</span><span class="s4">,</span><span class="s1">date</span><span class="s4">,</span><span class="s1">quality</span><span class="s4">,</span><span class="s1">sharpen</span><span class="s4">,</span><span class="s1">denoise</span><span class="s4">,</span><span class="s1">resample</span><span class="s4">,</span><span class="s1">resizeMode</span><span class="s4">,</span><span class="s1">targetW</span><span class="s4">};</span></p>
<p class="p4"><span class="s1">}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p2"><span class="s1">async</span><span class="s4"> </span><span class="s1">function</span><span class="s4"> </span><span class="s13">call</span><span class="s4">(</span><span class="s13">fn</span><span class="s4">, ...</span><span class="s13">args</span><span class="s4">){</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">return</span><span class="s4"> </span><span class="s5">await</span><span class="s4"> </span><span class="s5">new</span><span class="s4"> </span><span class="s12">Promise</span><span class="s4">((</span><span class="s1">res</span><span class="s4">,</span><span class="s1">rej</span><span class="s4">)=&gt;{ </span><span class="s1">google</span><span class="s4">.</span><span class="s1">script</span><span class="s4">.</span><span class="s1">run</span><span class="s4">.</span><span class="s1">withSuccessHandler</span><span class="s4">(</span><span class="s1">res</span><span class="s4">).</span><span class="s1">withFailureHandler</span><span class="s4">(</span><span class="s1">rej</span><span class="s4">)[</span><span class="s1">fn</span><span class="s4">](...</span><span class="s1">args</span><span class="s4">); });</span></p>
<p class="p4"><span class="s1">}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s1">// —— プレビュー —— //</span></p>
<p class="p8"><span class="s5">let</span><span class="s4"> </span><span class="s13">pvTotal</span><span class="s4">=</span><span class="s7">0</span><span class="s4">; </span><span class="s5">let</span><span class="s4"> </span><span class="s13">pvCache</span><span class="s4">={}; </span><span class="s1">// index -&gt; {mime,b64,img}</span></p>
<p class="p8"><span class="s5">let</span><span class="s4"> </span><span class="s13">outCache</span><span class="s4">=</span><span class="s5">new</span><span class="s4"> </span><span class="s12">Map</span><span class="s4">(); </span><span class="s1">// key -&gt; Blob</span></p>
<p class="p10"><span class="s5">const</span><span class="s4"> </span><span class="s1">optKey</span><span class="s4"> = (</span><span class="s1">o</span><span class="s4">)=&gt;</span><span class="s12">JSON</span><span class="s4">.</span><span class="s1">stringify</span><span class="s4">({</span><span class="s1">q</span><span class="s4">:</span><span class="s1">o</span><span class="s4">.</span><span class="s1">quality</span><span class="s4">,</span><span class="s1">s</span><span class="s4">:</span><span class="s1">o</span><span class="s4">.</span><span class="s1">sharpen</span><span class="s4">,</span><span class="s1">d</span><span class="s4">:</span><span class="s1">o</span><span class="s4">.</span><span class="s1">denoise</span><span class="s4">,</span><span class="s1">r</span><span class="s4">:</span><span class="s1">o</span><span class="s4">.</span><span class="s1">resample</span><span class="s4">,</span><span class="s1">m</span><span class="s4">:</span><span class="s1">o</span><span class="s4">.</span><span class="s1">resizeMode</span><span class="s4">,</span><span class="s1">w</span><span class="s4">:</span><span class="s1">o</span><span class="s4">.</span><span class="s1">targetW</span><span class="s4">});</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p6"><span class="s13">$</span><span class="s4">(</span><span class="s1">'#btnLoadPrev'</span><span class="s4">).</span><span class="s13">addEventListener</span><span class="s4">(</span><span class="s1">'click'</span><span class="s4">, </span><span class="s5">async</span><span class="s4"> ()=&gt;{</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">pvTotal</span><span class="s4"> = </span><span class="s5">await</span><span class="s4"> </span><span class="s1">call</span><span class="s4">(</span><span class="s6">'countImages'</span><span class="s4">); </span><span class="s5">if</span><span class="s4"> (!</span><span class="s1">pvTotal</span><span class="s4">){ </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#pvMeta'</span><span class="s4">).</span><span class="s1">textContent</span><span class="s4">=</span><span class="s6">'画像なし'</span><span class="s4">; </span><span class="s5">return</span><span class="s4">; }</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#pvIndex'</span><span class="s4">).</span><span class="s1">max</span><span class="s4"> = </span><span class="s1">pvTotal</span><span class="s4">; </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#pvIndex'</span><span class="s4">).</span><span class="s1">value</span><span class="s4"> = </span><span class="s7">1</span><span class="s4">; </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#pvIndexLabel'</span><span class="s4">).</span><span class="s1">textContent</span><span class="s4"> = </span><span class="s6">`1 / </span><span class="s4">${</span><span class="s1">pvTotal</span><span class="s4">}</span><span class="s6">`</span><span class="s4">; </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#pvMeta'</span><span class="s4">).</span><span class="s1">textContent</span><span class="s4"> = </span><span class="s6">`全</span><span class="s4">${</span><span class="s1">pvTotal</span><span class="s4">}</span><span class="s6">枚`</span><span class="s4">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">await</span><span class="s4"> </span><span class="s1">renderAllModes</span><span class="s4">(</span><span class="s7">1</span><span class="s4">);</span></p>
<p class="p4"><span class="s1">});</span></p>
<p class="p6"><span class="s13">$</span><span class="s4">(</span><span class="s1">'#btnPrev'</span><span class="s4">).</span><span class="s13">addEventListener</span><span class="s4">(</span><span class="s1">'click'</span><span class="s4">, ()=&gt;{ </span><span class="s5">const</span><span class="s4"> </span><span class="s13">cur</span><span class="s4">=</span><span class="s12">Number</span><span class="s4">(</span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#pvIndex'</span><span class="s4">).</span><span class="s13">value</span><span class="s4">); </span><span class="s5">if</span><span class="s4">(</span><span class="s13">cur</span><span class="s4">&gt;</span><span class="s7">1</span><span class="s4">){ </span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#pvIndex'</span><span class="s4">).</span><span class="s13">value</span><span class="s4">=</span><span class="s13">cur</span><span class="s4">-</span><span class="s7">1</span><span class="s4">; </span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#pvIndex'</span><span class="s4">).</span><span class="s13">dispatchEvent</span><span class="s4">(</span><span class="s5">new</span><span class="s4"> </span><span class="s12">Event</span><span class="s4">(</span><span class="s1">'input'</span><span class="s4">)); }});</span></p>
<p class="p10"><span class="s1">$</span><span class="s4">(</span><span class="s6">'#btnNext'</span><span class="s4">).</span><span class="s1">addEventListener</span><span class="s4">(</span><span class="s6">'click'</span><span class="s4">, ()=&gt;{ </span><span class="s5">const</span><span class="s4"> </span><span class="s1">cur</span><span class="s4">=</span><span class="s12">Number</span><span class="s4">(</span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#pvIndex'</span><span class="s4">).</span><span class="s1">value</span><span class="s4">); </span><span class="s5">if</span><span class="s4">(</span><span class="s1">cur</span><span class="s4">&lt;</span><span class="s1">pvTotal</span><span class="s4">){ </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#pvIndex'</span><span class="s4">).</span><span class="s1">value</span><span class="s4">=</span><span class="s1">cur</span><span class="s4">+</span><span class="s7">1</span><span class="s4">; </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#pvIndex'</span><span class="s4">).</span><span class="s1">dispatchEvent</span><span class="s4">(</span><span class="s5">new</span><span class="s4"> </span><span class="s12">Event</span><span class="s4">(</span><span class="s6">'input'</span><span class="s4">)); }});</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p6"><span class="s13">document</span><span class="s4">.</span><span class="s13">addEventListener</span><span class="s4">(</span><span class="s1">'keydown'</span><span class="s4">, (</span><span class="s13">e</span><span class="s4">)=&gt;{ </span><span class="s5">if</span><span class="s4">(</span><span class="s13">e</span><span class="s4">.</span><span class="s13">key</span><span class="s4">===</span><span class="s1">'ArrowLeft'</span><span class="s4">) </span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#btnPrev'</span><span class="s4">).</span><span class="s13">click</span><span class="s4">(); </span><span class="s5">else</span><span class="s4"> </span><span class="s5">if</span><span class="s4">(</span><span class="s13">e</span><span class="s4">.</span><span class="s13">key</span><span class="s4">===</span><span class="s1">'ArrowRight'</span><span class="s4">) </span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#btnNext'</span><span class="s4">).</span><span class="s13">click</span><span class="s4">(); });</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p10"><span class="s1">$</span><span class="s4">(</span><span class="s6">'#pvIndex'</span><span class="s4">).</span><span class="s1">addEventListener</span><span class="s4">(</span><span class="s6">'input'</span><span class="s4">, </span><span class="s5">async</span><span class="s4"> (</span><span class="s1">e</span><span class="s4">)=&gt;{ </span><span class="s5">const</span><span class="s4"> </span><span class="s1">idx</span><span class="s4">=</span><span class="s12">Number</span><span class="s4">(</span><span class="s1">e</span><span class="s4">.</span><span class="s1">target</span><span class="s4">.</span><span class="s1">value</span><span class="s4">); </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#pvIndexLabel'</span><span class="s4">).</span><span class="s1">textContent</span><span class="s4">=</span><span class="s6">`</span><span class="s4">${</span><span class="s1">idx</span><span class="s4">}</span><span class="s6"> / </span><span class="s4">${</span><span class="s1">pvTotal</span><span class="s4">}</span><span class="s6">`</span><span class="s4">; </span><span class="s5">await</span><span class="s4"> </span><span class="s1">renderAllModes</span><span class="s4">(</span><span class="s1">idx</span><span class="s4">); });</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s1">// モード切替（詳細セクションのセレクタと連動）</span></p>
<p class="p6"><span class="s5">const</span><span class="s4"> </span><span class="s13">modeSelect</span><span class="s4"> = </span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#modeSelect'</span><span class="s4">);</span></p>
<p class="p10"><span class="s1">modeSelect</span><span class="s4">.</span><span class="s1">addEventListener</span><span class="s4">(</span><span class="s6">'change'</span><span class="s4">, ()=&gt;{</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">mode</span><span class="s4"> = </span><span class="s1">modeSelect</span><span class="s4">.</span><span class="s1">value</span><span class="s4">;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#modeSide'</span><span class="s4">).</span><span class="s13">style</span><span class="s4">.</span><span class="s13">display</span><span class="s4"> = </span><span class="s13">mode</span><span class="s4">===</span><span class="s1">'side'</span><span class="s4"> ? </span><span class="s1">''</span><span class="s4"> : </span><span class="s1">'none'</span><span class="s4">;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#modeSlider'</span><span class="s4">).</span><span class="s13">style</span><span class="s4">.</span><span class="s13">display</span><span class="s4"> = </span><span class="s13">mode</span><span class="s4">===</span><span class="s1">'slider'</span><span class="s4"> ? </span><span class="s1">''</span><span class="s4"> : </span><span class="s1">'none'</span><span class="s4">;</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#modeZoom'</span><span class="s4">).</span><span class="s13">style</span><span class="s4">.</span><span class="s13">display</span><span class="s4"> = </span><span class="s13">mode</span><span class="s4">===</span><span class="s1">'zoom'</span><span class="s4"> ? </span><span class="s1">''</span><span class="s4"> : </span><span class="s1">'none'</span><span class="s4">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">document</span><span class="s4">.</span><span class="s1">getElementById</span><span class="s4">(</span><span class="s6">'zoomRow'</span><span class="s4">).</span><span class="s1">style</span><span class="s4">.</span><span class="s1">display</span><span class="s4"> = </span><span class="s1">mode</span><span class="s4">===</span><span class="s6">'zoom'</span><span class="s4"> ? </span><span class="s6">''</span><span class="s4"> : </span><span class="s6">'none'</span><span class="s4">;</span></p>
<p class="p4"><span class="s1">});</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s1">// オプション変更で自動再描画（デバウンス）</span></p>
<p class="p6"><span class="s4">;[</span><span class="s1">'quality'</span><span class="s4">,</span><span class="s1">'sharpen'</span><span class="s4">,</span><span class="s1">'denoise'</span><span class="s4">,</span><span class="s1">'resample'</span><span class="s4">,</span><span class="s1">'resizeMode'</span><span class="s4">,</span><span class="s1">'targetW'</span><span class="s4">].</span><span class="s13">forEach</span><span class="s4">(</span><span class="s13">n</span><span class="s4">=&gt;{</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">document</span><span class="s4">.</span><span class="s1">querySelector</span><span class="s4">(</span><span class="s6">`[name="</span><span class="s4">${</span><span class="s1">n</span><span class="s4">}</span><span class="s6">"]`</span><span class="s4">).</span><span class="s1">addEventListener</span><span class="s4">(</span><span class="s6">'input'</span><span class="s4">, </span><span class="s1">debounce</span><span class="s4">(()=&gt;{</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s5">if</span><span class="s4">(</span><span class="s1">pvTotal</span><span class="s4">&gt;</span><span class="s7">0</span><span class="s4">){ </span><span class="s5">const</span><span class="s4"> </span><span class="s1">idx</span><span class="s4">=</span><span class="s12">Number</span><span class="s4">(</span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#pvIndex'</span><span class="s4">).</span><span class="s1">value</span><span class="s4">||</span><span class="s7">1</span><span class="s4">); </span><span class="s1">renderAllModes</span><span class="s4">(</span><span class="s1">idx</span><span class="s4">,</span><span class="s5">true</span><span class="s4">); </span><span class="s1">refreshAdvSummary</span><span class="s4">(); }</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>}, </span><span class="s7">200</span><span class="s1">));</span></p>
<p class="p4"><span class="s1">});</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p10"><span class="s5">async</span><span class="s4"> </span><span class="s5">function</span><span class="s4"> </span><span class="s1">renderAllModes</span><span class="s4">(</span><span class="s1">idx</span><span class="s4">, </span><span class="s1">bust</span><span class="s4">=</span><span class="s5">false</span><span class="s4">){</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> {</span><span class="s1">mime</span><span class="s4">,</span><span class="s1">b64</span><span class="s4">,</span><span class="s1">img</span><span class="s4">} = </span><span class="s5">await</span><span class="s4"> </span><span class="s1">ensurePreviewImage</span><span class="s4">(</span><span class="s1">idx</span><span class="s4">);</span></p>
<p class="p8"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">// サイドバイサイド</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">await</span><span class="s4"> </span><span class="s1">drawToCanvasFit</span><span class="s4">(</span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#pvSrc'</span><span class="s4">), </span><span class="s1">img</span><span class="s4">, </span><span class="s7">600</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">outImg</span><span class="s4"> = </span><span class="s5">await</span><span class="s4"> </span><span class="s1">getOutputImage</span><span class="s4">(</span><span class="s1">idx</span><span class="s4">, </span><span class="s1">mime</span><span class="s4">, </span><span class="s1">b64</span><span class="s4">, </span><span class="s1">bust</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">await</span><span class="s4"> </span><span class="s1">drawToCanvasFit</span><span class="s4">(</span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#pvDst'</span><span class="s4">), </span><span class="s1">outImg</span><span class="s4">, </span><span class="s7">600</span><span class="s4">);</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">// 比較スライダー</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">await</span><span class="s4"> </span><span class="s1">drawCompare</span><span class="s4">(</span><span class="s1">img</span><span class="s4">, </span><span class="s1">outImg</span><span class="s4">);</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">// ズーム</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">setupZoom</span><span class="s4">(</span><span class="s1">outImg</span><span class="s4">);</span></p>
<p class="p4"><span class="s1">}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p10"><span class="s5">async</span><span class="s4"> </span><span class="s5">function</span><span class="s4"> </span><span class="s1">ensurePreviewImage</span><span class="s4">(</span><span class="s1">idx</span><span class="s4">){</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">if</span><span class="s4">(</span><span class="s1">pvCache</span><span class="s4">[</span><span class="s1">idx</span><span class="s4">]) </span><span class="s5">return</span><span class="s4"> </span><span class="s1">pvCache</span><span class="s4">[</span><span class="s1">idx</span><span class="s4">];</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s13">pack</span><span class="s4"> = </span><span class="s5">await</span><span class="s4"> </span><span class="s13">call</span><span class="s4">(</span><span class="s1">'getImagesBatch'</span><span class="s4">, </span><span class="s13">idx</span><span class="s4">-</span><span class="s7">1</span><span class="s4">, </span><span class="s7">1</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">it</span><span class="s4"> = </span><span class="s1">pack</span><span class="s4">.</span><span class="s1">items</span><span class="s4">[</span><span class="s7">0</span><span class="s4">];</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">img</span><span class="s4"> = </span><span class="s5">await</span><span class="s4"> </span><span class="s1">loadImage</span><span class="s4">(</span><span class="s6">`data:</span><span class="s4">${</span><span class="s1">it</span><span class="s4">.</span><span class="s1">mime</span><span class="s4">}</span><span class="s6">;base64,</span><span class="s4">${</span><span class="s1">it</span><span class="s4">.</span><span class="s1">b64</span><span class="s4">}</span><span class="s6">`</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">return</span><span class="s4"> (</span><span class="s1">pvCache</span><span class="s4">[</span><span class="s1">idx</span><span class="s4">] = {</span><span class="s1">mime</span><span class="s4">:</span><span class="s1">it</span><span class="s4">.</span><span class="s1">mime</span><span class="s4">,</span><span class="s1">b64</span><span class="s4">:</span><span class="s1">it</span><span class="s4">.</span><span class="s1">b64</span><span class="s4">,</span><span class="s1">img</span><span class="s4">});</span></p>
<p class="p4"><span class="s1">}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p10"><span class="s5">async</span><span class="s4"> </span><span class="s5">function</span><span class="s4"> </span><span class="s1">getOutputImage</span><span class="s4">(</span><span class="s1">idx</span><span class="s4">, </span><span class="s1">mime</span><span class="s4">, </span><span class="s1">b64</span><span class="s4">, </span><span class="s1">bust</span><span class="s4">=</span><span class="s5">false</span><span class="s4">){</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">o</span><span class="s4">=</span><span class="s1">readOptions</span><span class="s4">(); </span><span class="s5">const</span><span class="s4"> </span><span class="s1">key</span><span class="s4"> = </span><span class="s1">idx</span><span class="s4">+</span><span class="s6">'|'</span><span class="s4">+</span><span class="s1">optKey</span><span class="s4">(</span><span class="s1">o</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">if</span><span class="s4">(!</span><span class="s1">bust</span><span class="s4"> &amp;&amp; </span><span class="s1">outCache</span><span class="s4">.</span><span class="s1">has</span><span class="s4">(</span><span class="s1">key</span><span class="s4">)) </span><span class="s5">return</span><span class="s4"> </span><span class="s5">await</span><span class="s4"> </span><span class="s1">blobToImage</span><span class="s4">(</span><span class="s1">outCache</span><span class="s4">.</span><span class="s5">get</span><span class="s4">(</span><span class="s1">key</span><span class="s4">));</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">blob</span><span class="s4"> = </span><span class="s5">await</span><span class="s4"> </span><span class="s1">convertWithOptions</span><span class="s4">(</span><span class="s1">b64</span><span class="s4">, </span><span class="s1">mime</span><span class="s4">, </span><span class="s1">o</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">outCache</span><span class="s4">.</span><span class="s5">set</span><span class="s4">(</span><span class="s1">key</span><span class="s4">, </span><span class="s1">blob</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">return</span><span class="s4"> </span><span class="s5">await</span><span class="s4"> </span><span class="s1">blobToImage</span><span class="s4">(</span><span class="s1">blob</span><span class="s4">);</span></p>
<p class="p4"><span class="s1">}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p10"><span class="s5">async</span><span class="s4"> </span><span class="s5">function</span><span class="s4"> </span><span class="s1">drawToCanvasFit</span><span class="s4">(</span><span class="s1">canvas</span><span class="s4">, </span><span class="s1">img</span><span class="s4">, </span><span class="s1">fitW</span><span class="s4">=</span><span class="s7">600</span><span class="s4">){</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">scale</span><span class="s4"> = </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s7">1</span><span class="s4">, </span><span class="s1">fitW</span><span class="s4">/</span><span class="s1">img</span><span class="s4">.</span><span class="s1">naturalWidth</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">w</span><span class="s4"> = </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">1</span><span class="s4">, </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">round</span><span class="s4">(</span><span class="s1">img</span><span class="s4">.</span><span class="s1">naturalWidth</span><span class="s4">*</span><span class="s1">scale</span><span class="s4">));</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">h</span><span class="s4"> = </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">1</span><span class="s4">, </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">round</span><span class="s4">(</span><span class="s1">img</span><span class="s4">.</span><span class="s1">naturalHeight</span><span class="s4">*</span><span class="s1">scale</span><span class="s4">));</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">canvas</span><span class="s4">.</span><span class="s1">width</span><span class="s4">=</span><span class="s1">w</span><span class="s4">; </span><span class="s1">canvas</span><span class="s4">.</span><span class="s1">height</span><span class="s4">=</span><span class="s1">h</span><span class="s4">; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">ctx</span><span class="s4">=</span><span class="s1">canvas</span><span class="s4">.</span><span class="s1">getContext</span><span class="s4">(</span><span class="s6">'2d'</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">imageSmoothingEnabled</span><span class="s4">=</span><span class="s5">true</span><span class="s4">; </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">imageSmoothingQuality</span><span class="s4">=</span><span class="s6">'high'</span><span class="s4">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">clearRect</span><span class="s4">(</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">w</span><span class="s4">,</span><span class="s1">h</span><span class="s4">); </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">drawImage</span><span class="s4">(</span><span class="s1">img</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">w</span><span class="s4">,</span><span class="s1">h</span><span class="s4">);</span></p>
<p class="p4"><span class="s1">}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s1">// 比較スライダー描画</span></p>
<p class="p10"><span class="s5">async</span><span class="s4"> </span><span class="s5">function</span><span class="s4"> </span><span class="s1">drawCompare</span><span class="s4">(</span><span class="s1">srcImg</span><span class="s4">, </span><span class="s1">outImg</span><span class="s4">){</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s13">base</span><span class="s4"> = </span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#cmpBase'</span><span class="s4">); </span><span class="s5">const</span><span class="s4"> </span><span class="s13">top</span><span class="s4"> = </span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#cmpTop'</span><span class="s4">); </span><span class="s5">const</span><span class="s4"> </span><span class="s13">wrap</span><span class="s4">=</span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#cmpWrap'</span><span class="s4">); </span><span class="s5">const</span><span class="s4"> </span><span class="s13">mask</span><span class="s4">=</span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#cmpMask'</span><span class="s4">); </span><span class="s5">const</span><span class="s4"> </span><span class="s13">handle</span><span class="s4">=</span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#cmpHandle'</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">dispW</span><span class="s4"> = </span><span class="s1">wrap</span><span class="s4">.</span><span class="s1">clientWidth</span><span class="s4"> || </span><span class="s7">600</span><span class="s4">; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">scale</span><span class="s4"> = </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s7">1</span><span class="s4">, </span><span class="s1">dispW</span><span class="s4">/</span><span class="s1">srcImg</span><span class="s4">.</span><span class="s1">naturalWidth</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">w</span><span class="s4"> = </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">1</span><span class="s4">, </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">round</span><span class="s4">(</span><span class="s1">srcImg</span><span class="s4">.</span><span class="s1">naturalWidth</span><span class="s4">*</span><span class="s1">scale</span><span class="s4">));</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">h</span><span class="s4"> = </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">1</span><span class="s4">, </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">round</span><span class="s4">(</span><span class="s1">srcImg</span><span class="s4">.</span><span class="s1">naturalHeight</span><span class="s4">*</span><span class="s1">scale</span><span class="s4">));</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span>[</span><span class="s1">base</span><span class="s4">, </span><span class="s1">top</span><span class="s4">].</span><span class="s1">forEach</span><span class="s4">(</span><span class="s1">c</span><span class="s4">=&gt;{ </span><span class="s1">c</span><span class="s4">.</span><span class="s1">width</span><span class="s4">=</span><span class="s1">w</span><span class="s4">; </span><span class="s1">c</span><span class="s4">.</span><span class="s1">height</span><span class="s4">=</span><span class="s1">h</span><span class="s4">; });</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">bctx</span><span class="s4"> = </span><span class="s1">base</span><span class="s4">.</span><span class="s1">getContext</span><span class="s4">(</span><span class="s6">'2d'</span><span class="s4">); </span><span class="s5">const</span><span class="s4"> </span><span class="s1">tctx</span><span class="s4"> = </span><span class="s1">top</span><span class="s4">.</span><span class="s1">getContext</span><span class="s4">(</span><span class="s6">'2d'</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">bctx</span><span class="s4">.</span><span class="s1">imageSmoothingEnabled</span><span class="s4">=</span><span class="s5">true</span><span class="s4">; </span><span class="s1">bctx</span><span class="s4">.</span><span class="s1">imageSmoothingQuality</span><span class="s4">=</span><span class="s6">'high'</span><span class="s4">; </span><span class="s1">bctx</span><span class="s4">.</span><span class="s1">clearRect</span><span class="s4">(</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">w</span><span class="s4">,</span><span class="s1">h</span><span class="s4">); </span><span class="s1">bctx</span><span class="s4">.</span><span class="s1">drawImage</span><span class="s4">(</span><span class="s1">srcImg</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">w</span><span class="s4">,</span><span class="s1">h</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">tctx</span><span class="s4">.</span><span class="s1">imageSmoothingEnabled</span><span class="s4">=</span><span class="s5">true</span><span class="s4">; </span><span class="s1">tctx</span><span class="s4">.</span><span class="s1">imageSmoothingQuality</span><span class="s4">=</span><span class="s6">'high'</span><span class="s4">; </span><span class="s1">tctx</span><span class="s4">.</span><span class="s1">clearRect</span><span class="s4">(</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">w</span><span class="s4">,</span><span class="s1">h</span><span class="s4">); </span><span class="s1">tctx</span><span class="s4">.</span><span class="s1">drawImage</span><span class="s4">(</span><span class="s1">outImg</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">w</span><span class="s4">,</span><span class="s1">h</span><span class="s4">);</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">range</span><span class="s4">=</span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#cmpRange'</span><span class="s4">); </span><span class="s5">const</span><span class="s4"> </span><span class="s1">pct</span><span class="s4">=</span><span class="s1">range</span><span class="s4">.</span><span class="s1">value</span><span class="s4">|</span><span class="s7">0</span><span class="s4">; </span><span class="s1">mask</span><span class="s4">.</span><span class="s1">style</span><span class="s4">.</span><span class="s1">width</span><span class="s4">=</span><span class="s1">pct</span><span class="s4">+</span><span class="s6">'%'</span><span class="s4">; </span><span class="s1">handle</span><span class="s4">.</span><span class="s1">style</span><span class="s4">.</span><span class="s1">left</span><span class="s4">=</span><span class="s1">pct</span><span class="s4">+</span><span class="s6">'%'</span><span class="s4">;</span></p>
<p class="p8"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">// ドラッグ操作</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">setPct</span><span class="s4">=(</span><span class="s1">p</span><span class="s4">)=&gt;{ </span><span class="s5">const</span><span class="s4"> </span><span class="s1">clamped</span><span class="s4">=</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">0</span><span class="s4">,</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s7">100</span><span class="s4">,</span><span class="s1">p</span><span class="s4">)); </span><span class="s1">range</span><span class="s4">.</span><span class="s1">value</span><span class="s4">=</span><span class="s1">clamped</span><span class="s4">; </span><span class="s1">mask</span><span class="s4">.</span><span class="s1">style</span><span class="s4">.</span><span class="s1">width</span><span class="s4">=</span><span class="s1">clamped</span><span class="s4">+</span><span class="s6">'%'</span><span class="s4">; </span><span class="s1">handle</span><span class="s4">.</span><span class="s1">style</span><span class="s4">.</span><span class="s1">left</span><span class="s4">=</span><span class="s1">clamped</span><span class="s4">+</span><span class="s6">'%'</span><span class="s4">; };</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">let</span><span class="s4"> </span><span class="s1">dragging</span><span class="s4">=</span><span class="s5">false</span><span class="s4">; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">onMove</span><span class="s4">=(</span><span class="s1">e</span><span class="s4">)=&gt;{ </span><span class="s5">if</span><span class="s4">(!</span><span class="s1">dragging</span><span class="s4">) </span><span class="s5">return</span><span class="s4">; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">rect</span><span class="s4">=</span><span class="s1">wrap</span><span class="s4">.</span><span class="s1">getBoundingClientRect</span><span class="s4">(); </span><span class="s5">const</span><span class="s4"> </span><span class="s1">p</span><span class="s4">=( (</span><span class="s1">e</span><span class="s4">.</span><span class="s1">touches</span><span class="s4">? </span><span class="s1">e</span><span class="s4">.</span><span class="s1">touches</span><span class="s4">[</span><span class="s7">0</span><span class="s4">].</span><span class="s1">clientX</span><span class="s4">:</span><span class="s1">e</span><span class="s4">.</span><span class="s1">clientX</span><span class="s4">)-</span><span class="s1">rect</span><span class="s4">.</span><span class="s1">left</span><span class="s4">)/</span><span class="s1">rect</span><span class="s4">.</span><span class="s1">width</span><span class="s4">*</span><span class="s7">100</span><span class="s4">; </span><span class="s1">setPct</span><span class="s4">(</span><span class="s1">p</span><span class="s4">); };</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">handle</span><span class="s4">.</span><span class="s1">onmousedown</span><span class="s4">=()=&gt;</span><span class="s1">dragging</span><span class="s4">=</span><span class="s5">true</span><span class="s4">; </span><span class="s1">handle</span><span class="s4">.</span><span class="s1">ontouchstart</span><span class="s4">=()=&gt;</span><span class="s1">dragging</span><span class="s4">=</span><span class="s5">true</span><span class="s4">; </span><span class="s1">window</span><span class="s4">.</span><span class="s1">addEventListener</span><span class="s4">(</span><span class="s6">'mousemove'</span><span class="s4">,</span><span class="s1">onMove</span><span class="s4">); </span><span class="s1">window</span><span class="s4">.</span><span class="s1">addEventListener</span><span class="s4">(</span><span class="s6">'touchmove'</span><span class="s4">,</span><span class="s1">onMove</span><span class="s4">,{</span><span class="s1">passive</span><span class="s4">:</span><span class="s5">false</span><span class="s4">}); </span><span class="s1">window</span><span class="s4">.</span><span class="s1">addEventListener</span><span class="s4">(</span><span class="s6">'mouseup'</span><span class="s4">,()=&gt;</span><span class="s1">dragging</span><span class="s4">=</span><span class="s5">false</span><span class="s4">); </span><span class="s1">window</span><span class="s4">.</span><span class="s1">addEventListener</span><span class="s4">(</span><span class="s6">'touchend'</span><span class="s4">,()=&gt;</span><span class="s1">dragging</span><span class="s4">=</span><span class="s5">false</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">range</span><span class="s4">.</span><span class="s1">oninput</span><span class="s4">=(</span><span class="s1">e</span><span class="s4">)=&gt;</span><span class="s1">setPct</span><span class="s4">(</span><span class="s1">e</span><span class="s4">.</span><span class="s1">target</span><span class="s4">.</span><span class="s1">value</span><span class="s4">);</span></p>
<p class="p4"><span class="s1">}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s1">// ズームビュー</span></p>
<p class="p10"><span class="s5">let</span><span class="s4"> </span><span class="s1">zoomState</span><span class="s4">={</span><span class="s1">scale</span><span class="s4">:</span><span class="s7">1</span><span class="s4">, </span><span class="s1">ox</span><span class="s4">:</span><span class="s7">0</span><span class="s4">, </span><span class="s1">oy</span><span class="s4">:</span><span class="s7">0</span><span class="s4">, </span><span class="s1">img</span><span class="s4">:</span><span class="s5">null</span><span class="s4">};</span></p>
<p class="p10"><span class="s5">function</span><span class="s4"> </span><span class="s1">setupZoom</span><span class="s4">(</span><span class="s1">img</span><span class="s4">){</span></p>
<p class="p6"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s13">box</span><span class="s4">=</span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#zoomBox'</span><span class="s4">); </span><span class="s5">const</span><span class="s4"> </span><span class="s13">cvs</span><span class="s4">=</span><span class="s13">$</span><span class="s4">(</span><span class="s1">'#zoomCanvas'</span><span class="s4">); </span><span class="s5">const</span><span class="s4"> </span><span class="s13">ctx</span><span class="s4">=</span><span class="s13">cvs</span><span class="s4">.</span><span class="s13">getContext</span><span class="s4">(</span><span class="s1">'2d'</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">img</span><span class="s4">=</span><span class="s1">img</span><span class="s4">; </span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">scale</span><span class="s4">=(</span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#zoom'</span><span class="s4">).</span><span class="s1">value</span><span class="s4">|</span><span class="s7">0</span><span class="s4">)/</span><span class="s7">100</span><span class="s4">; </span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">ox</span><span class="s4">=</span><span class="s7">0</span><span class="s4">; </span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">oy</span><span class="s4">=</span><span class="s7">0</span><span class="s4">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">fitW</span><span class="s4"> = </span><span class="s1">box</span><span class="s4">.</span><span class="s1">clientWidth</span><span class="s4">||</span><span class="s7">600</span><span class="s4">; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">w</span><span class="s4">=</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">round</span><span class="s4">(</span><span class="s1">img</span><span class="s4">.</span><span class="s1">naturalWidth</span><span class="s4">*</span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">scale</span><span class="s4">), </span><span class="s1">h</span><span class="s4">=</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">round</span><span class="s4">(</span><span class="s1">img</span><span class="s4">.</span><span class="s1">naturalHeight</span><span class="s4">*</span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">scale</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">width</span><span class="s4">=</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">50</span><span class="s4">, </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s1">fitW</span><span class="s4">, </span><span class="s1">w</span><span class="s4">)); </span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">height</span><span class="s4">=</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">50</span><span class="s4">, </span><span class="s12">Math</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">round</span><span class="s4">(</span><span class="s1">fitW</span><span class="s4">*</span><span class="s7">0.6</span><span class="s4">), </span><span class="s1">h</span><span class="s4">));</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">draw</span><span class="s4">=()=&gt;{ </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">clearRect</span><span class="s4">(</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">width</span><span class="s4">,</span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">height</span><span class="s4">); </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">imageSmoothingEnabled</span><span class="s4">=</span><span class="s5">true</span><span class="s4">; </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">imageSmoothingQuality</span><span class="s4">=</span><span class="s6">'high'</span><span class="s4">; </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">drawImage</span><span class="s4">(</span><span class="s1">img</span><span class="s4">, </span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">ox</span><span class="s4">, </span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">oy</span><span class="s4">, </span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">width</span><span class="s4">/</span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">scale</span><span class="s4">, </span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">height</span><span class="s4">/</span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">scale</span><span class="s4">, </span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">width</span><span class="s4">,</span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">height</span><span class="s4">); };</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s13">draw</span><span class="s1">();</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">// ドラッグでパン</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">let</span><span class="s4"> </span><span class="s1">dragging</span><span class="s4">=</span><span class="s5">false</span><span class="s4">, </span><span class="s1">sx</span><span class="s4">=</span><span class="s7">0</span><span class="s4">, </span><span class="s1">sy</span><span class="s4">=</span><span class="s7">0</span><span class="s4">, </span><span class="s1">sox</span><span class="s4">=</span><span class="s7">0</span><span class="s4">, </span><span class="s1">soy</span><span class="s4">=</span><span class="s7">0</span><span class="s4">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">start</span><span class="s4">=(</span><span class="s1">x</span><span class="s4">,</span><span class="s1">y</span><span class="s4">)=&gt;{</span><span class="s1">dragging</span><span class="s4">=</span><span class="s5">true</span><span class="s4">; </span><span class="s1">sx</span><span class="s4">=</span><span class="s1">x</span><span class="s4">; </span><span class="s1">sy</span><span class="s4">=</span><span class="s1">y</span><span class="s4">; </span><span class="s1">sox</span><span class="s4">=</span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">ox</span><span class="s4">; </span><span class="s1">soy</span><span class="s4">=</span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">oy</span><span class="s4">};</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">move</span><span class="s4">=(</span><span class="s1">x</span><span class="s4">,</span><span class="s1">y</span><span class="s4">)=&gt;{ </span><span class="s5">if</span><span class="s4">(!</span><span class="s1">dragging</span><span class="s4">) </span><span class="s5">return</span><span class="s4">; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">dx</span><span class="s4">=(</span><span class="s1">x</span><span class="s4">-</span><span class="s1">sx</span><span class="s4">)/</span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">scale</span><span class="s4">; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">dy</span><span class="s4">=(</span><span class="s1">y</span><span class="s4">-</span><span class="s1">sy</span><span class="s4">)/</span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">scale</span><span class="s4">; </span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">ox</span><span class="s4">=</span><span class="s1">sox</span><span class="s4">-</span><span class="s1">dx</span><span class="s4">; </span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">oy</span><span class="s4">=</span><span class="s1">soy</span><span class="s4">-</span><span class="s1">dy</span><span class="s4">; </span><span class="s1">draw</span><span class="s4">(); };</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">end</span><span class="s4">=()=&gt;</span><span class="s1">dragging</span><span class="s4">=</span><span class="s5">false</span><span class="s4">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">onmousedown</span><span class="s4">=</span><span class="s1">e</span><span class="s4">=&gt;</span><span class="s1">start</span><span class="s4">(</span><span class="s1">e</span><span class="s4">.</span><span class="s1">offsetX</span><span class="s4">,</span><span class="s1">e</span><span class="s4">.</span><span class="s1">offsetY</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">onmousemove</span><span class="s4">=</span><span class="s1">e</span><span class="s4">=&gt;</span><span class="s1">move</span><span class="s4">(</span><span class="s1">e</span><span class="s4">.</span><span class="s1">offsetX</span><span class="s4">,</span><span class="s1">e</span><span class="s4">.</span><span class="s1">offsetY</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">onmouseup</span><span class="s4">=</span><span class="s1">end</span><span class="s4">; </span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">onmouseleave</span><span class="s4">=</span><span class="s1">end</span><span class="s4">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">ontouchstart</span><span class="s4">=</span><span class="s1">e</span><span class="s4">=&gt;{ </span><span class="s5">const</span><span class="s4"> </span><span class="s1">t</span><span class="s4">=</span><span class="s1">e</span><span class="s4">.</span><span class="s1">touches</span><span class="s4">[</span><span class="s7">0</span><span class="s4">]; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">r</span><span class="s4">=</span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">getBoundingClientRect</span><span class="s4">(); </span><span class="s1">start</span><span class="s4">(</span><span class="s1">t</span><span class="s4">.</span><span class="s1">clientX</span><span class="s4">-</span><span class="s1">r</span><span class="s4">.</span><span class="s1">left</span><span class="s4">,</span><span class="s1">t</span><span class="s4">.</span><span class="s1">clientY</span><span class="s4">-</span><span class="s1">r</span><span class="s4">.</span><span class="s1">top</span><span class="s4">); };</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">ontouchmove</span><span class="s4">=</span><span class="s1">e</span><span class="s4">=&gt;{ </span><span class="s5">const</span><span class="s4"> </span><span class="s1">t</span><span class="s4">=</span><span class="s1">e</span><span class="s4">.</span><span class="s1">touches</span><span class="s4">[</span><span class="s7">0</span><span class="s4">]; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">r</span><span class="s4">=</span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">getBoundingClientRect</span><span class="s4">(); </span><span class="s1">move</span><span class="s4">(</span><span class="s1">t</span><span class="s4">.</span><span class="s1">clientX</span><span class="s4">-</span><span class="s1">r</span><span class="s4">.</span><span class="s1">left</span><span class="s4">,</span><span class="s1">t</span><span class="s4">.</span><span class="s1">clientY</span><span class="s4">-</span><span class="s1">r</span><span class="s4">.</span><span class="s1">top</span><span class="s4">); </span><span class="s1">e</span><span class="s4">.</span><span class="s1">preventDefault</span><span class="s4">(); };</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">ontouchend</span><span class="s4">=</span><span class="s1">end</span><span class="s4">;</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">// ホイールでズーム</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#zoom'</span><span class="s4">).</span><span class="s1">oninput</span><span class="s4">=(</span><span class="s1">e</span><span class="s4">)=&gt;{ </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#zoomLabel'</span><span class="s4">).</span><span class="s1">textContent</span><span class="s4">=</span><span class="s1">e</span><span class="s4">.</span><span class="s1">target</span><span class="s4">.</span><span class="s1">value</span><span class="s4">+</span><span class="s6">'%'</span><span class="s4">; </span><span class="s1">zoomState</span><span class="s4">.</span><span class="s1">scale</span><span class="s4">=(</span><span class="s1">e</span><span class="s4">.</span><span class="s1">target</span><span class="s4">.</span><span class="s1">value</span><span class="s4">|</span><span class="s7">0</span><span class="s4">)/</span><span class="s7">100</span><span class="s4">; </span><span class="s1">draw</span><span class="s4">(); };</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">cvs</span><span class="s4">.</span><span class="s1">onwheel</span><span class="s4">=(</span><span class="s1">e</span><span class="s4">)=&gt;{ </span><span class="s1">e</span><span class="s4">.</span><span class="s1">preventDefault</span><span class="s4">(); </span><span class="s5">let</span><span class="s4"> </span><span class="s1">v</span><span class="s4">=</span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#zoom'</span><span class="s4">).</span><span class="s1">value</span><span class="s4">|</span><span class="s7">0</span><span class="s4">; </span><span class="s1">v</span><span class="s4">+= (</span><span class="s1">e</span><span class="s4">.</span><span class="s1">deltaY</span><span class="s4">&lt;</span><span class="s7">0</span><span class="s4">? </span><span class="s7">10</span><span class="s4">:-</span><span class="s7">10</span><span class="s4">); </span><span class="s1">v</span><span class="s4">=</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">50</span><span class="s4">,</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s7">300</span><span class="s4">,</span><span class="s1">v</span><span class="s4">)); </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#zoom'</span><span class="s4">).</span><span class="s1">value</span><span class="s4">=</span><span class="s1">v</span><span class="s4">; </span><span class="s1">$</span><span class="s4">(</span><span class="s6">'#zoom'</span><span class="s4">).</span><span class="s1">dispatchEvent</span><span class="s4">(</span><span class="s5">new</span><span class="s4"> </span><span class="s12">Event</span><span class="s4">(</span><span class="s6">'input'</span><span class="s4">)); };</span></p>
<p class="p4"><span class="s1">}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s1">// 画像読み込み等</span></p>
<p class="p10"><span class="s5">function</span><span class="s4"> </span><span class="s1">loadImage</span><span class="s4">(</span><span class="s1">src</span><span class="s4">){ </span><span class="s5">return</span><span class="s4"> </span><span class="s5">new</span><span class="s4"> </span><span class="s12">Promise</span><span class="s4">((</span><span class="s1">resolve</span><span class="s4">,</span><span class="s1">reject</span><span class="s4">)=&gt;{ </span><span class="s5">const</span><span class="s4"> </span><span class="s1">img</span><span class="s4">=</span><span class="s5">new</span><span class="s4"> </span><span class="s12">Image</span><span class="s4">(); </span><span class="s1">img</span><span class="s4">.</span><span class="s1">onload</span><span class="s4">=()=&gt;</span><span class="s1">resolve</span><span class="s4">(</span><span class="s1">img</span><span class="s4">); </span><span class="s1">img</span><span class="s4">.</span><span class="s1">onerror</span><span class="s4">=</span><span class="s1">reject</span><span class="s4">; </span><span class="s1">img</span><span class="s4">.</span><span class="s1">src</span><span class="s4">=</span><span class="s1">src</span><span class="s4">; }); }</span></p>
<p class="p10"><span class="s5">function</span><span class="s4"> </span><span class="s1">blobToImage</span><span class="s4">(</span><span class="s1">blob</span><span class="s4">){ </span><span class="s5">return</span><span class="s4"> </span><span class="s5">new</span><span class="s4"> </span><span class="s12">Promise</span><span class="s4">((</span><span class="s1">resolve</span><span class="s4">,</span><span class="s1">reject</span><span class="s4">)=&gt;{ </span><span class="s5">const</span><span class="s4"> </span><span class="s1">url</span><span class="s4">=</span><span class="s12">URL</span><span class="s4">.</span><span class="s1">createObjectURL</span><span class="s4">(</span><span class="s1">blob</span><span class="s4">); </span><span class="s5">const</span><span class="s4"> </span><span class="s1">img</span><span class="s4">=</span><span class="s5">new</span><span class="s4"> </span><span class="s12">Image</span><span class="s4">(); </span><span class="s1">img</span><span class="s4">.</span><span class="s1">onload</span><span class="s4">=()=&gt;{</span><span class="s12">URL</span><span class="s4">.</span><span class="s1">revokeObjectURL</span><span class="s4">(</span><span class="s1">url</span><span class="s4">); </span><span class="s1">resolve</span><span class="s4">(</span><span class="s1">img</span><span class="s4">)}; </span><span class="s1">img</span><span class="s4">.</span><span class="s1">onerror</span><span class="s4">=(</span><span class="s1">e</span><span class="s4">)=&gt;{</span><span class="s12">URL</span><span class="s4">.</span><span class="s1">revokeObjectURL</span><span class="s4">(</span><span class="s1">url</span><span class="s4">); </span><span class="s1">reject</span><span class="s4">(</span><span class="s1">e</span><span class="s4">)}; </span><span class="s1">img</span><span class="s4">.</span><span class="s1">src</span><span class="s4">=</span><span class="s1">url</span><span class="s4">; }); }</span></p>
<p class="p10"><span class="s5">function</span><span class="s4"> </span><span class="s1">canvasToBlob</span><span class="s4">(</span><span class="s1">canvas</span><span class="s4">, </span><span class="s1">type</span><span class="s4">, </span><span class="s1">quality</span><span class="s4">){ </span><span class="s5">return</span><span class="s4"> </span><span class="s5">new</span><span class="s4"> </span><span class="s12">Promise</span><span class="s4">((</span><span class="s1">resolve</span><span class="s4">)=&gt;{ </span><span class="s1">canvas</span><span class="s4">.</span><span class="s1">toBlob</span><span class="s4">((</span><span class="s1">blob</span><span class="s4">)=&gt;</span><span class="s1">resolve</span><span class="s4">(</span><span class="s1">blob</span><span class="s4">), </span><span class="s1">type</span><span class="s4">, </span><span class="s1">quality</span><span class="s4">); }); }</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s1">// 変換本体</span></p>
<p class="p10"><span class="s5">async</span><span class="s4"> </span><span class="s5">function</span><span class="s4"> </span><span class="s1">convertWithOptions</span><span class="s4">(</span><span class="s1">b64</span><span class="s4">, </span><span class="s1">mime</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">){</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">img</span><span class="s4"> = </span><span class="s5">await</span><span class="s4"> </span><span class="s1">loadImage</span><span class="s4">(</span><span class="s6">`data:</span><span class="s4">${</span><span class="s1">mime</span><span class="s4">}</span><span class="s6">;base64,</span><span class="s4">${</span><span class="s1">b64</span><span class="s4">}</span><span class="s6">`</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">src</span><span class="s4"> = </span><span class="s1">document</span><span class="s4">.</span><span class="s1">createElement</span><span class="s4">(</span><span class="s6">'canvas'</span><span class="s4">); </span><span class="s1">src</span><span class="s4">.</span><span class="s1">width</span><span class="s4">=</span><span class="s1">img</span><span class="s4">.</span><span class="s1">naturalWidth</span><span class="s4">; </span><span class="s1">src</span><span class="s4">.</span><span class="s1">height</span><span class="s4">=</span><span class="s1">img</span><span class="s4">.</span><span class="s1">naturalHeight</span><span class="s4">; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">sctx</span><span class="s4">=</span><span class="s1">src</span><span class="s4">.</span><span class="s1">getContext</span><span class="s4">(</span><span class="s6">'2d'</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">sctx</span><span class="s4">.</span><span class="s1">clearRect</span><span class="s4">(</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">src</span><span class="s4">.</span><span class="s1">width</span><span class="s4">,</span><span class="s1">src</span><span class="s4">.</span><span class="s1">height</span><span class="s4">); </span><span class="s5">if</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">denoise</span><span class="s4">&gt;</span><span class="s7">0</span><span class="s4">) </span><span class="s1">sctx</span><span class="s4">.</span><span class="s1">filter</span><span class="s4">=</span><span class="s6">`blur(</span><span class="s4">${</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">denoise</span><span class="s4">}</span><span class="s6">px)`</span><span class="s4">; </span><span class="s1">sctx</span><span class="s4">.</span><span class="s1">fillStyle</span><span class="s4">=</span><span class="s6">'#ffffff'</span><span class="s4">; </span><span class="s1">sctx</span><span class="s4">.</span><span class="s1">fillRect</span><span class="s4">(</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">src</span><span class="s4">.</span><span class="s1">width</span><span class="s4">,</span><span class="s1">src</span><span class="s4">.</span><span class="s1">height</span><span class="s4">); </span><span class="s1">sctx</span><span class="s4">.</span><span class="s1">drawImage</span><span class="s4">(</span><span class="s1">img</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">src</span><span class="s4">.</span><span class="s1">width</span><span class="s4">,</span><span class="s1">src</span><span class="s4">.</span><span class="s1">height</span><span class="s4">); </span><span class="s1">sctx</span><span class="s4">.</span><span class="s1">filter</span><span class="s4">=</span><span class="s6">'none'</span><span class="s4">;</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">let</span><span class="s4"> </span><span class="s1">targetW</span><span class="s4">, </span><span class="s1">targetH</span><span class="s4">; </span><span class="s5">if</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">resizeMode</span><span class="s4">===</span><span class="s6">'none'</span><span class="s4">){ </span><span class="s1">targetW</span><span class="s4">=</span><span class="s1">src</span><span class="s4">.</span><span class="s1">width</span><span class="s4">; </span><span class="s1">targetH</span><span class="s4">=</span><span class="s1">src</span><span class="s4">.</span><span class="s1">height</span><span class="s4">; } </span><span class="s5">else</span><span class="s4"> { </span><span class="s1">targetW</span><span class="s4">=</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">targetW</span><span class="s4">|</span><span class="s7">0</span><span class="s4">; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">scale</span><span class="s4">=</span><span class="s1">targetW</span><span class="s4">/</span><span class="s1">src</span><span class="s4">.</span><span class="s1">width</span><span class="s4">; </span><span class="s1">targetH</span><span class="s4">=</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">1</span><span class="s4">,</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">round</span><span class="s4">(</span><span class="s1">src</span><span class="s4">.</span><span class="s1">height</span><span class="s4">*</span><span class="s1">scale</span><span class="s4">)); }</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">let</span><span class="s4"> </span><span class="s1">resized</span><span class="s4"> = </span><span class="s5">await</span><span class="s4"> </span><span class="s1">resizeCanvas</span><span class="s4">(</span><span class="s1">src</span><span class="s4">, </span><span class="s1">targetW</span><span class="s4">, </span><span class="s1">targetH</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">resample</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">if</span><span class="s4">(</span><span class="s1">opt</span><span class="s4">.</span><span class="s1">sharpen</span><span class="s4">&gt;</span><span class="s7">0</span><span class="s4">) </span><span class="s1">applySharpen</span><span class="s4">(</span><span class="s1">resized</span><span class="s4">.</span><span class="s1">getContext</span><span class="s4">(</span><span class="s6">'2d'</span><span class="s4">), </span><span class="s1">resized</span><span class="s4">.</span><span class="s1">width</span><span class="s4">, </span><span class="s1">resized</span><span class="s4">.</span><span class="s1">height</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">sharpen</span><span class="s4">);</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">blob</span><span class="s4"> = </span><span class="s5">await</span><span class="s4"> </span><span class="s1">canvasToBlob</span><span class="s4">(</span><span class="s1">resized</span><span class="s4">, </span><span class="s6">'image/jpeg'</span><span class="s4">, </span><span class="s1">opt</span><span class="s4">.</span><span class="s1">quality</span><span class="s4">); </span><span class="s5">return</span><span class="s4"> </span><span class="s1">blob</span><span class="s4">;</span></p>
<p class="p4"><span class="s1">}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p10"><span class="s5">async</span><span class="s4"> </span><span class="s5">function</span><span class="s4"> </span><span class="s1">resizeCanvas</span><span class="s4">(</span><span class="s1">srcCanvas</span><span class="s4">, </span><span class="s1">targetW</span><span class="s4">, </span><span class="s1">targetH</span><span class="s4">, </span><span class="s1">method</span><span class="s4">=</span><span class="s6">'auto'</span><span class="s4">){</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s5">if</span><span class="s4">(</span><span class="s1">method</span><span class="s4">===</span><span class="s6">'progressive'</span><span class="s4"> &amp;&amp; (</span><span class="s1">targetW</span><span class="s4"> &lt; </span><span class="s1">srcCanvas</span><span class="s4">.</span><span class="s1">width</span><span class="s4"> || </span><span class="s1">targetH</span><span class="s4"> &lt; </span><span class="s1">srcCanvas</span><span class="s4">.</span><span class="s1">height</span><span class="s4">)){</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s5">let</span><span class="s4"> </span><span class="s1">cur</span><span class="s4">=</span><span class="s1">srcCanvas</span><span class="s4">; </span><span class="s5">while</span><span class="s4">(</span><span class="s1">cur</span><span class="s4">.</span><span class="s1">width</span><span class="s4">*</span><span class="s7">0.5</span><span class="s4">&gt;</span><span class="s1">targetW</span><span class="s4">){ </span><span class="s5">const</span><span class="s4"> </span><span class="s1">step</span><span class="s4">=</span><span class="s1">document</span><span class="s4">.</span><span class="s1">createElement</span><span class="s4">(</span><span class="s6">'canvas'</span><span class="s4">); </span><span class="s1">step</span><span class="s4">.</span><span class="s1">width</span><span class="s4">=</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">1</span><span class="s4">,</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">round</span><span class="s4">(</span><span class="s1">cur</span><span class="s4">.</span><span class="s1">width</span><span class="s4">*</span><span class="s7">0.5</span><span class="s4">)); </span><span class="s1">step</span><span class="s4">.</span><span class="s1">height</span><span class="s4">=</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">1</span><span class="s4">,</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">round</span><span class="s4">(</span><span class="s1">cur</span><span class="s4">.</span><span class="s1">height</span><span class="s4">*</span><span class="s7">0.5</span><span class="s4">)); </span><span class="s5">const</span><span class="s4"> </span><span class="s1">ctx</span><span class="s4">=</span><span class="s1">step</span><span class="s4">.</span><span class="s1">getContext</span><span class="s4">(</span><span class="s6">'2d'</span><span class="s4">); </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">imageSmoothingEnabled</span><span class="s4">=</span><span class="s5">true</span><span class="s4">; </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">imageSmoothingQuality</span><span class="s4">=</span><span class="s6">'high'</span><span class="s4">; </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">fillStyle</span><span class="s4">=</span><span class="s6">'#ffffff'</span><span class="s4">; </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">fillRect</span><span class="s4">(</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">step</span><span class="s4">.</span><span class="s1">width</span><span class="s4">,</span><span class="s1">step</span><span class="s4">.</span><span class="s1">height</span><span class="s4">); </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">drawImage</span><span class="s4">(</span><span class="s1">cur</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">step</span><span class="s4">.</span><span class="s1">width</span><span class="s4">,</span><span class="s1">step</span><span class="s4">.</span><span class="s1">height</span><span class="s4">); </span><span class="s1">cur</span><span class="s4">=</span><span class="s1">step</span><span class="s4">; }</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">dst</span><span class="s4">=</span><span class="s1">document</span><span class="s4">.</span><span class="s1">createElement</span><span class="s4">(</span><span class="s6">'canvas'</span><span class="s4">); </span><span class="s1">dst</span><span class="s4">.</span><span class="s1">width</span><span class="s4">=</span><span class="s1">targetW</span><span class="s4">; </span><span class="s1">dst</span><span class="s4">.</span><span class="s1">height</span><span class="s4">=</span><span class="s1">targetH</span><span class="s4">; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">dctx</span><span class="s4">=</span><span class="s1">dst</span><span class="s4">.</span><span class="s1">getContext</span><span class="s4">(</span><span class="s6">'2d'</span><span class="s4">); </span><span class="s1">dctx</span><span class="s4">.</span><span class="s1">imageSmoothingEnabled</span><span class="s4">=</span><span class="s5">true</span><span class="s4">; </span><span class="s1">dctx</span><span class="s4">.</span><span class="s1">imageSmoothingQuality</span><span class="s4">=</span><span class="s6">'high'</span><span class="s4">; </span><span class="s1">dctx</span><span class="s4">.</span><span class="s1">fillStyle</span><span class="s4">=</span><span class="s6">'#ffffff'</span><span class="s4">; </span><span class="s1">dctx</span><span class="s4">.</span><span class="s1">fillRect</span><span class="s4">(</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">dst</span><span class="s4">.</span><span class="s1">width</span><span class="s4">,</span><span class="s1">dst</span><span class="s4">.</span><span class="s1">height</span><span class="s4">); </span><span class="s1">dctx</span><span class="s4">.</span><span class="s1">drawImage</span><span class="s4">(</span><span class="s1">cur</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">dst</span><span class="s4">.</span><span class="s1">width</span><span class="s4">,</span><span class="s1">dst</span><span class="s4">.</span><span class="s1">height</span><span class="s4">); </span><span class="s5">return</span><span class="s4"> </span><span class="s1">dst</span><span class="s4">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>} </span><span class="s5">else</span><span class="s1"> {</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">    </span></span><span class="s5">const</span><span class="s4"> </span><span class="s1">dst</span><span class="s4">=</span><span class="s1">document</span><span class="s4">.</span><span class="s1">createElement</span><span class="s4">(</span><span class="s6">'canvas'</span><span class="s4">); </span><span class="s1">dst</span><span class="s4">.</span><span class="s1">width</span><span class="s4">=</span><span class="s1">targetW</span><span class="s4">; </span><span class="s1">dst</span><span class="s4">.</span><span class="s1">height</span><span class="s4">=</span><span class="s1">targetH</span><span class="s4">; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">ctx</span><span class="s4">=</span><span class="s1">dst</span><span class="s4">.</span><span class="s1">getContext</span><span class="s4">(</span><span class="s6">'2d'</span><span class="s4">); </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">imageSmoothingEnabled</span><span class="s4">=</span><span class="s5">true</span><span class="s4">; </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">imageSmoothingQuality</span><span class="s4">=</span><span class="s6">'high'</span><span class="s4">; </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">fillStyle</span><span class="s4">=</span><span class="s6">'#ffffff'</span><span class="s4">; </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">fillRect</span><span class="s4">(</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">dst</span><span class="s4">.</span><span class="s1">width</span><span class="s4">,</span><span class="s1">dst</span><span class="s4">.</span><span class="s1">height</span><span class="s4">); </span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">drawImage</span><span class="s4">(</span><span class="s1">srcCanvas</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">dst</span><span class="s4">.</span><span class="s1">width</span><span class="s4">,</span><span class="s1">dst</span><span class="s4">.</span><span class="s1">height</span><span class="s4">); </span><span class="s5">return</span><span class="s4"> </span><span class="s1">dst</span><span class="s4">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p4"><span class="s1">}</span></p>
<p class="p7"><span class="s11"></span><br></p>
<p class="p8"><span class="s1">// 修正版シャープ</span></p>
<p class="p10"><span class="s5">function</span><span class="s4"> </span><span class="s1">applySharpen</span><span class="s4">(</span><span class="s1">ctx</span><span class="s4">,</span><span class="s1">w</span><span class="s4">,</span><span class="s1">h</span><span class="s4">,</span><span class="s1">a</span><span class="s4">){</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">a</span><span class="s4">=</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">max</span><span class="s4">(</span><span class="s7">0</span><span class="s4">,</span><span class="s12">Math</span><span class="s4">.</span><span class="s1">min</span><span class="s4">(</span><span class="s7">1</span><span class="s4">,</span><span class="s1">a</span><span class="s4">)); </span><span class="s5">const</span><span class="s4"> </span><span class="s1">src</span><span class="s4">=</span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">getImageData</span><span class="s4">(</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s1">w</span><span class="s4">,</span><span class="s1">h</span><span class="s4">); </span><span class="s5">const</span><span class="s4"> </span><span class="s1">dst</span><span class="s4">=</span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">createImageData</span><span class="s4">(</span><span class="s1">w</span><span class="s4">,</span><span class="s1">h</span><span class="s4">); </span><span class="s5">const</span><span class="s4"> </span><span class="s1">sp</span><span class="s4">=</span><span class="s1">src</span><span class="s4">.</span><span class="s1">data</span><span class="s4">, </span><span class="s1">dp</span><span class="s4">=</span><span class="s1">dst</span><span class="s4">.</span><span class="s1">data</span><span class="s4">; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">center</span><span class="s4">=</span><span class="s7">1</span><span class="s4">+</span><span class="s7">4</span><span class="s4">*</span><span class="s1">a</span><span class="s4">, </span><span class="s1">side</span><span class="s4">=-</span><span class="s1">a</span><span class="s4">; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">clamp</span><span class="s4">=</span><span class="s1">v</span><span class="s4">=&gt;</span><span class="s1">v</span><span class="s4">&lt;</span><span class="s7">0</span><span class="s4">?</span><span class="s7">0</span><span class="s4">:</span><span class="s1">v</span><span class="s4">&gt;</span><span class="s7">255</span><span class="s4">?</span><span class="s7">255</span><span class="s4">:</span><span class="s1">v</span><span class="s4">; </span><span class="s5">const</span><span class="s4"> </span><span class="s1">idx</span><span class="s4">=(</span><span class="s1">x</span><span class="s4">,</span><span class="s1">y</span><span class="s4">,</span><span class="s1">c</span><span class="s4">)=&gt;((</span><span class="s1">y</span><span class="s4">*</span><span class="s1">w</span><span class="s4">+</span><span class="s1">x</span><span class="s4">)&lt;&lt;</span><span class="s7">2</span><span class="s4">)+</span><span class="s1">c</span><span class="s4">;</span></p>
<p class="p8"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">// 辺は原画</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s5">for</span><span class="s1">(</span><span class="s5">let</span><span class="s1"> </span><span class="s13">x</span><span class="s1">=</span><span class="s7">0</span><span class="s1">;</span><span class="s13">x</span><span class="s1">&lt;</span><span class="s13">w</span><span class="s1">;</span><span class="s13">x</span><span class="s1">++){ </span><span class="s5">for</span><span class="s1">(</span><span class="s5">let</span><span class="s1"> </span><span class="s13">c</span><span class="s1">=</span><span class="s7">0</span><span class="s1">;</span><span class="s13">c</span><span class="s1">&lt;</span><span class="s7">4</span><span class="s1">;</span><span class="s13">c</span><span class="s1">++){ </span><span class="s13">dp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s13">x</span><span class="s1">,</span><span class="s7">0</span><span class="s1">,</span><span class="s13">c</span><span class="s1">)]=</span><span class="s13">sp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s13">x</span><span class="s1">,</span><span class="s7">0</span><span class="s1">,</span><span class="s13">c</span><span class="s1">)]; </span><span class="s13">dp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s13">x</span><span class="s1">,</span><span class="s13">h</span><span class="s1">-</span><span class="s7">1</span><span class="s1">,</span><span class="s13">c</span><span class="s1">)]=</span><span class="s13">sp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s13">x</span><span class="s1">,</span><span class="s13">h</span><span class="s1">-</span><span class="s7">1</span><span class="s1">,</span><span class="s13">c</span><span class="s1">)]; } }</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s5">for</span><span class="s1">(</span><span class="s5">let</span><span class="s1"> </span><span class="s13">y</span><span class="s1">=</span><span class="s7">0</span><span class="s1">;</span><span class="s13">y</span><span class="s1">&lt;</span><span class="s13">h</span><span class="s1">;</span><span class="s13">y</span><span class="s1">++){ </span><span class="s5">for</span><span class="s1">(</span><span class="s5">let</span><span class="s1"> </span><span class="s13">c</span><span class="s1">=</span><span class="s7">0</span><span class="s1">;</span><span class="s13">c</span><span class="s1">&lt;</span><span class="s7">4</span><span class="s1">;</span><span class="s13">c</span><span class="s1">++){ </span><span class="s13">dp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s7">0</span><span class="s1">,</span><span class="s13">y</span><span class="s1">,</span><span class="s13">c</span><span class="s1">)]=</span><span class="s13">sp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s7">0</span><span class="s1">,</span><span class="s13">y</span><span class="s1">,</span><span class="s13">c</span><span class="s1">)]; </span><span class="s13">dp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s13">w</span><span class="s1">-</span><span class="s7">1</span><span class="s1">,</span><span class="s13">y</span><span class="s1">,</span><span class="s13">c</span><span class="s1">)]=</span><span class="s13">sp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s13">w</span><span class="s1">-</span><span class="s7">1</span><span class="s1">,</span><span class="s13">y</span><span class="s1">,</span><span class="s13">c</span><span class="s1">)]; } }</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span></span><span class="s5">for</span><span class="s1">(</span><span class="s5">let</span><span class="s1"> </span><span class="s13">y</span><span class="s1">=</span><span class="s7">1</span><span class="s1">;</span><span class="s13">y</span><span class="s1">&lt;</span><span class="s13">h</span><span class="s1">-</span><span class="s7">1</span><span class="s1">;</span><span class="s13">y</span><span class="s1">++){</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span></span><span class="s5">for</span><span class="s1">(</span><span class="s5">let</span><span class="s1"> </span><span class="s13">x</span><span class="s1">=</span><span class="s7">1</span><span class="s1">;</span><span class="s13">x</span><span class="s1">&lt;</span><span class="s13">w</span><span class="s1">-</span><span class="s7">1</span><span class="s1">;</span><span class="s13">x</span><span class="s1">++){</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s5">for</span><span class="s1">(</span><span class="s5">let</span><span class="s1"> </span><span class="s13">c</span><span class="s1">=</span><span class="s7">0</span><span class="s1">;</span><span class="s13">c</span><span class="s1">&lt;</span><span class="s7">3</span><span class="s1">;</span><span class="s13">c</span><span class="s1">++){</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s5">const</span><span class="s1"> </span><span class="s13">v</span><span class="s1"> = </span><span class="s13">sp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s13">x</span><span class="s1">,</span><span class="s13">y</span><span class="s1">,</span><span class="s13">c</span><span class="s1">)]*</span><span class="s13">center</span><span class="s1"> + </span><span class="s13">sp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s13">x</span><span class="s1">-</span><span class="s7">1</span><span class="s1">,</span><span class="s13">y</span><span class="s1">,</span><span class="s13">c</span><span class="s1">)]*</span><span class="s13">side</span><span class="s1"> + </span><span class="s13">sp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s13">x</span><span class="s1">+</span><span class="s7">1</span><span class="s1">,</span><span class="s13">y</span><span class="s1">,</span><span class="s13">c</span><span class="s1">)]*</span><span class="s13">side</span><span class="s1"> + </span><span class="s13">sp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s13">x</span><span class="s1">,</span><span class="s13">y</span><span class="s1">-</span><span class="s7">1</span><span class="s1">,</span><span class="s13">c</span><span class="s1">)]*</span><span class="s13">side</span><span class="s1"> + </span><span class="s13">sp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s13">x</span><span class="s1">,</span><span class="s13">y</span><span class="s1">+</span><span class="s7">1</span><span class="s1">,</span><span class="s13">c</span><span class="s1">)]*</span><span class="s13">side</span><span class="s1">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">        </span></span><span class="s13">dp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s13">x</span><span class="s1">,</span><span class="s13">y</span><span class="s1">,</span><span class="s13">c</span><span class="s1">)] = </span><span class="s13">clamp</span><span class="s1">(</span><span class="s13">v</span><span class="s1">);</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span>}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">      </span></span><span class="s13">dp</span><span class="s1">[</span><span class="s13">idx</span><span class="s1">(</span><span class="s13">x</span><span class="s1">,</span><span class="s13">y</span><span class="s1">,</span><span class="s7">3</span><span class="s1">)] = </span><span class="s7">255</span><span class="s1">;</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p4"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p10"><span class="s4"><span class="Apple-converted-space">  </span></span><span class="s1">ctx</span><span class="s4">.</span><span class="s1">putImageData</span><span class="s4">(</span><span class="s1">dst</span><span class="s4">,</span><span class="s7">0</span><span class="s4">,</span><span class="s7">0</span><span class="s4">);</span></p>
<p class="p4"><span class="s1">}</span></p>
<p class="p2"><span class="s3">&lt;/</span><span class="s1">script</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;/</span><span class="s1">body</span><span class="s3">&gt;</span></p>
<p class="p2"><span class="s3">&lt;/</span><span class="s1">html</span><span class="s3">&gt;</span></p>
<p class="p7"><span class="s11"></span><br></p>
</body>
</html>
